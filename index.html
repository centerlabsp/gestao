<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Contratos CenterlabSP</title>
    <link rel="icon" type="image/png" href="icone.png">

    <style>
        /* --- ESTILOS GERAIS --- */
        :root {
            --bg-color: #f4f5f7;
            --card-bg: #ffffff;
            --primary: #005f87;
            --text-color: #333;
            --border-radius: 6px;
            --shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 15px;
            padding-bottom: 80px;
            font-size: 13px;
            /* Fonte base reduzida */
        }

        .header-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .header-logo {
            max-height: 55px;
            width: auto;
        }

        h1 {
            text-align: center;
            color: var(--primary);
            font-size: 1.8em;
            font-weight: 900;
            text-transform: uppercase;
            margin: 0;
        }

        /* BOT√ïES DE NAVEGA√á√ÉO */
        .nav-btn {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background-color: #28a745;
            color: white;
            padding: 10px 15px;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: 0.2s;
        }

        .nav-btn:hover {
            background-color: #218838;
        }

        .nav-btn-left {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background-color: #17a2b8;
            color: white;
            padding: 10px 15px;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: 0.2s;
        }

        .nav-btn-left:hover {
            background-color: #138496;
        }

        .control-panel {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            max-width: 1350px;
            margin-left: auto;
            margin-right: auto;
        }

        .header-grid {
            display: grid;
            grid-template-columns: 220px 180px 2fr 1.2fr 80px 80px 1.1fr;
            gap: 10px;
            margin-bottom: 15px;
            align-items: end;
        }

        .dates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .sn-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 5px;
        }

        .sn-field-group {
            display: block;
            animation: fadeIn 0.5s;
        }

        .sn-label-dynamic {
            font-size: 0.8em;
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 2px;
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        input,
        select {
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            font-size: 13px;
            height: 34px;
            background-color: #fff;
        }

        #machineType,
        #consultantName,
        #contractType {
            font-size: 11px;
        }

        select {
            background-color: #f9f9f9;
        }

        label {
            font-weight: 700;
            font-size: 0.9em;
            display: block;
            margin-bottom: 4px;
            color: #333;
        }

        optgroup {
            font-weight: 800;
            color: #004085;
            background: #eef6fc;
        }

        option.sub-header {
            background: #ddd;
            color: #555;
            font-weight: bold;
            font-style: italic;
            font-size: 0.95em;
        }

        option {
            background: #fff;
            color: #333;
            padding-left: 10px;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        button.add-btn {
            background-color: #0056b3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 15px;
            flex: 3;
            padding: 10px;
        }

        button.notify-btn {
            background-color: #ffc107;
            color: #333;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 15px;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            max-width: 1350px;
            margin-left: auto;
            margin-right: auto;
            background: #e9ecef;
            padding: 10px;
            border-radius: 6px;
            align-items: center;
        }

        .filter-input {
            flex: 2;
            height: 36px;
        }

        .filter-select {
            flex: 1;
            height: 36px;
        }

        .filter-count {
            font-weight: bold;
            color: #666;
        }

        @media (max-width: 1100px) {
            .header-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 900px) {

            .header-grid,
            .sn-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .header-container {
                flex-direction: column;
                text-align: center;
            }

            .nav-btn,
            .nav-btn-left {
                position: static;
                transform: none;
                margin-top: 10px;
                display: inline-block;
                width: 100%;
                box-sizing: border-box;
                margin-bottom: 5px;
            }
        }

        /* CARD */
        .board-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            align-items: flex-start;
            min-height: 300px;
        }

        .card {
            background: var(--card-bg);
            width: 100%;
            max-width: 365px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 12px;
            /* Padding reduzido */
            border-top: 5px solid var(--primary);
            position: relative;
            transition: transform 0.2s;
            box-sizing: border-box;
        }

        .card.deleted-card {
            opacity: 0.7;
            border-top-color: #555 !important;
            background: #f0f0f0;
            border: 2px dashed #999;
        }

        .card-header-area {
            margin-bottom: 10px;
        }

        .consultant-badge {
            display: inline-block;
            font-size: 0.7em;
            font-weight: 700;
            color: #555;
            background-color: #e9ecef;
            padding: 1px 5px;
            border-radius: 3px;
            margin-bottom: 4px;
            text-transform: uppercase;
            border: 1px solid #ddd;
        }

        .card-top-flex {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 2px;
        }

        .card-client {
            font-size: 1.1em;
            font-weight: 800;
            color: #000;
            text-transform: uppercase;
            white-space: nowrap;
            cursor: default;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .card-badges {
            display: flex;
            gap: 3px;
            align-items: center;
            flex-wrap: wrap;
        }

        .badge {
            background-color: #28a745;
            color: white;
            font-size: 0.7em;
            font-weight: bold;
            padding: 1px 5px;
            border-radius: 4px;
            text-transform: uppercase;
            display: inline-block;
            white-space: nowrap;
        }

        .badge.urgent-badge {
            background-color: #dc3545;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.8;
            }

            100% {
                opacity: 1;
            }
        }

        .card-city {
            font-size: 0.85em;
            font-style: italic;
            color: #666;
            margin-bottom: 4px;
            display: block;
            margin-top: 1px;
        }

        .card-machine-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        .card-machine-name {
            color: #0056b3;
            font-weight: 800;
            font-size: 0.95em;
            text-transform: uppercase;
        }

        .card-sn-badge {
            background-color: #e9ecef;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 0.8em;
            font-weight: 600;
            white-space: pre-wrap;
            flex: 1;
        }

        .tech-status-label {
            display: inline-block;
            margin-top: 4px;
            padding: 1px 5px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: 800;
            text-transform: uppercase;
            border: 1px solid transparent;
        }

        .urgent-wrapper {
            display: flex;
            align-items: center;
            gap: 2px;
            margin-left: auto;
            border: 1px solid #dc3545;
            border-radius: 3px;
            padding: 0 4px;
            background: #fff0f0;
        }

        .urgent-check {
            width: 12px;
            height: 12px;
            cursor: pointer;
            margin: 0;
        }

        .urgent-label {
            color: #dc3545;
            font-size: 0.7em;
            font-weight: 800;
            margin: 0;
            cursor: pointer;
        }

        .card-actions-top {
            position: absolute;
            top: 6px;
            right: 6px;
            display: flex;
            gap: 4px;
        }

        .action-btn {
            background: none;
            border: none;
            font-size: 1.1em;
            cursor: pointer;
            padding: 0 2px;
        }

        .btn-edit {
            color: #0056b3;
        }

        .btn-trash {
            color: #ccc;
        }

        .btn-trash:hover {
            color: orange;
        }

        .btn-restore {
            color: #28a745;
        }

        .btn-perm-delete {
            color: #dc3545;
        }

        .negotiation-box {
            background-color: #eef6fc;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
            border: 1px solid #d1e7dd;
        }

        .status-select {
            width: 100%;
            background-color: #daeaf6;
            color: #004494;
            font-weight: 800;
            font-size: 0.85em;
            padding: 5px 8px;
            text-transform: uppercase;
            border: none;
            border-bottom: 1px solid #b3d7ff;
            cursor: pointer;
            height: auto;
        }

        .negotiation-body {
            padding: 8px;
        }

        .neg-row {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
            justify-content: flex-start;
            height: 24px;
        }

        .neg-label {
            font-weight: 700;
            color: #0056b3;
            font-size: 0.8em;
            margin-right: 6px;
            white-space: nowrap;
            width: 115px;
            display: flex;
            align-items: center;
            height: 100%;
        }

        .neg-input {
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 0 4px;
            font-size: 0.8em;
            background: #fff;
            color: #333;
            height: 22px;
            flex: 1;
        }

        /* CHECKLIST COMPACTO */
        .checklist {
            max-height: 320px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 4px;
            margin-bottom: 8px;
            background: #fff;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            height: 22px;
            margin-bottom: 1px;
            white-space: nowrap;
            overflow: hidden;
            font-size: 11px;
            /* Fonte reduzida */
        }

        .checklist-item input[type="checkbox"] {
            width: 13px;
            height: 13px;
            margin: 0 4px 0 0;
            cursor: pointer;
            flex-shrink: 0;
        }

        .checklist-item label {
            margin: 0;
            padding: 0;
            color: #333;
            font-weight: normal;
            line-height: 22px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .checklist-input-text-soft,
        .checklist-date-inline {
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 0 2px;
            font-size: 10px;
            color: #555;
            background: #fafafa;
            margin-left: 4px;
            height: 18px;
            width: auto;
            max-width: 100px;
            /* Mais estreito */
        }

        .checklist-date-label {
            font-size: 10px;
            color: #999;
            margin-left: 4px;
            margin-right: 1px;
            font-style: italic;
            font-weight: normal;
        }

        /* √çCONES MIN√öSCULOS */
        .action-icon-group {
            display: flex;
            gap: 2px;
            margin-left: 4px;
            flex-shrink: 0;
        }

        .btn-msg-tiny {
            border: none;
            border-radius: 2px;
            cursor: pointer;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            text-decoration: none;
            padding: 0;
        }

        .btn-whatsapp {
            background-color: #25d366;
            color: white;
        }

        .btn-whatsapp:hover {
            background-color: #128c7e;
        }

        .btn-email {
            background-color: #007bff;
            color: white;
        }

        .btn-email:hover {
            background-color: #0056b3;
        }

        /* COMENT√ÅRIOS */
        .comments-section {
            border-top: 1px solid #eee;
            padding-top: 6px;
        }

        .comment-form-grid {
            display: flex;
            gap: 4px;
            margin-bottom: 4px;
        }

        .comment-select {
            padding: 0 2px;
            height: 24px;
            font-size: 0.75em;
            border: 1px solid #ddd;
            border-radius: 3px;
            background: #fff;
            flex: 1;
        }

        .comment-input-row {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .comment-input-text {
            padding: 3px;
            height: 28px;
            font-size: 0.8em;
            border: 1px solid #ddd;
            border-radius: 3px;
            flex: 1;
        }

        .comment-btn-save {
            width: 32px;
            height: 28px;
            font-size: 1.1em;
            cursor: pointer;
            border: 1px solid #28a745;
            background: #28a745;
            color: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .comment-list {
            list-style: none;
            padding: 0;
            margin-top: 6px;
            font-size: 0.75em;
            max-height: 100px;
            overflow-y: auto;
        }

        .comment-item {
            background: #f1f1f1;
            border: 1px solid #eee;
            padding: 4px 5px;
            margin-bottom: 3px;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 1px;
            padding-bottom: 1px;
            font-size: 0.9em;
        }

        .comment-meta {
            font-weight: bold;
            color: #005f87;
        }

        .comment-time {
            font-size: 0.8em;
            color: #888;
            font-style: italic;
        }

        .comment-body {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .comment-text {
            color: #444;
            word-break: break-word;
            flex: 1;
        }

        .comment-actions {
            display: flex;
            gap: 4px;
            margin-left: 4px;
        }

        .comment-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            padding: 0;
        }

        .progress-container {
            background-color: #e0e0e0;
            border-radius: 10px;
            height: 14px;
            width: 100%;
            margin: 2px 0 6px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            text-align: center;
            line-height: 14px;
            color: white;
            font-size: 9px;
            font-weight: bold;
            transition: width 0.3s;
            background-color: #dc3545;
        }

        .last-updated {
            font-size: 0.7em;
            color: #666;
            text-align: right;
            margin-top: 4px;
            margin-bottom: 1px;
            font-style: italic;
        }

        #status-indicator {
            text-align: center;
            font-weight: bold;
            color: #666;
            font-size: 0.8em;
            margin-bottom: 5px;
        }

        #toast {
            visibility: hidden;
            min-width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 12px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }

        /* MODAL */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-box {
            background: white;
            padding: 15px;
            border-radius: 6px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            font-size: 13px;
        }

        .modal-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
            color: var(--primary);
            text-transform: uppercase;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .modal-form-group {
            margin-bottom: 8px;
        }

        .modal-form-group label {
            margin-bottom: 3px;
            color: #555;
            font-size: 0.9em;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-modal-cancel {
            background: #ccc;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.95em;
        }

        .btn-modal-save {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.95em;
        }
    </style>
</head>

<body>

    <div class="header-container">
        <a href="comercial.html" class="nav-btn-left" target="_blank">üìä Painel Comercial</a>

        <img src="logo.png" onerror="this.style.display='none'" alt="Logo" class="header-logo">
        <h1><strong>GEST√ÉO DE CONTRATOS - EQUIPAMENTOS</strong></h1>

        <a href="painel.html" class="nav-btn" target="_blank">‚öôÔ∏è Painel T√©cnico</a>
    </div>

    <div id="status-indicator">Conectando... ‚è≥</div>

    <div class="control-panel">
        <div class="header-grid">
            <div>
                <label>Equipamentos</label>
                <select id="machineType" onchange="window.updateSnFields()">
                    <option value="" disabled selected>Selecione o equipamento</option>
                    <optgroup label="FABRICANTE: SIEMENS">
                        <option disabled class="sub-header">--- >-LINHA ATELLICA-< ---</option>
                        <option value="ATELLICA SC">ATELLICA SC</option>
                        <option value="ATELLICA SCI">ATELLICA SCI</option>
                        <option value="ATELLICA SI">ATELLICA SI</option>
                        <option value="ATELLICA SCCI">ATELLICA SCCI</option>
                        <option value="ATELLICA SCII">ATELLICA SCII</option>
                        <option disabled class="sub-header">--- BIOQU√çMICA ---</option>
                        <option value="ADVIA 1800">ADVIA 1800</option>
                        <option value="ADVIA 2120">ADVIA 2120</option>
                        <option value="BN PROSPEC">BN PROSPEC</option>
                        <option value="DIMENSION EXL / RXL">DIMENSION EXL / RXL</option>
                        <option disabled class="sub-header">--- HEMATOLOGIA ---</option>
                        <option value="ADVIA 360">ADVIA 360</option>
                        <option value="ADVIA 560">ADVIA 560</option>
                        <option value="HEMATEK 3000">HEMATEK 3000</option>
                        <option disabled class="sub-header">--- IMUNOLOGIA ---</option>
                        <option value="CENTAUR CP">CENTAUR CP</option>
                        <option value="CENTAUR XP">CENTAUR XP</option>
                        <option value="IMMULITE 2000 XPI">IMMULITE 2000 XPI</option>
                        <option disabled class="sub-header">--- COAGULA√á√ÉO ---</option>
                        <option value="CA 660">CA 660</option>
                        <option value="CS 2500">CS 2500</option>
                        <option value="FIBRINTIMER II">FIBRINTIMER II</option>
                        <option disabled class="sub-header">--- GASOMETRIA ---</option>
                        <option value="EPOC NXS / EPOC MC">EPOC NXS / EPOC MC</option>
                        <option value="RAPIDLAB 348 / 348EX">RAPIDLAB 348 / 348EX</option>
                        <option value="RP 500 / RP 500e">RP 500 / RP 500e</option>
                        <option disabled class="sub-header">--- URIAN√ÅLISE ---</option>
                        <option value="CLINITEK ADVANTUS">CLINITEK ADVANTUS</option>
                        <option value="CLINITEK STATUS">CLINITEK STATUS</option>
                    </optgroup>
                    <optgroup label="FABRICANTE: LABTEST">
                        <option disabled class="sub-header">--- BIOQU√çMICA ---</option>
                        <option value="AUDMAX 360 C/ ISE">AUDMAX 360 C/ ISE</option>
                        <option value="AUDMAX EVOLUTION">AUDMAX EVOLUTION</option>
                        <option value="CS 240">CS 240</option>
                        <option value="CS 400">CS 400</option>
                        <option value="CS 800">CS 800</option>
                        <option value="LABMAX 100">LABMAX 100</option>
                        <option value="LABMAX 240 / PREMIUM">LABMAX 240 / PREMIUM</option>
                        <option value="LABMAX 450I">LABMAX 450I</option>
                        <option value="LABMAX 560">LABMAX 560</option>
                        <option value="LABMAX PLENNO">LABMAX PLENNO</option>
                        <option disabled class="sub-header">--- HEMATOLOGIA ---</option>
                        <option value="SDH 20">SDH 20</option>
                        <option value="SDH 5">SDH 5</option>
                    </optgroup>
                    <optgroup label="FABRICANTE: NIHON">
                        <option disabled class="sub-header">--- HEMATOLOGIA ---</option>
                        <option value="MEK 6500">MEK 6500</option>
                        <option value="MEK 6550">MEK 6550</option>
                        <option value="MEK 7300">MEK 7300</option>
                        <option value="MEK 9100">MEK 9100</option>
                        <option value="MEK-9200K">MEK-9200K</option>
                    </optgroup>
                    <optgroup label="FABRICANTE: MHLAB">
                        <option disabled class="sub-header">--- BIOQU√çMICA ---</option>
                        <option value="PKL 125">PKL 125</option>
                        <option value="CA 200">CA 200</option>
                        <option disabled class="sub-header">--- HEMATOLOGIA ---</option>
                        <option value="BH-5100">BH-5100</option>
                        <option value="BH-5390">BH-5390</option>
                        <option disabled class="sub-header">--- URIAN√ÅLISE ---</option>
                        <option value="URIT US-500">URIT US-500</option>
                    </optgroup>
                    <optgroup label="FABRICANTE: IN VITRO">
                        <option disabled class="sub-header">--- HEMATOLOGIA ---</option>
                        <option value="HUMANCOUNT 30 TS">HUMANCOUNT 30 TS</option>
                        <option disabled class="sub-header">--- √çONS ---</option>
                        <option value="HUMALYTE PLUS 3">HUMALYTE PLUS 3</option>
                        <option value="HUMALYTE PLUS 5">HUMALYTE PLUS 5</option>
                    </optgroup>
                    <optgroup label="FABRICANTE: WAMA">
                        <option disabled class="sub-header">--- COAGULA√á√ÉO ---</option>
                        <option value="COAGMASTER 2.0 / 4.0">COAGMASTER 2.0 / 4.0</option>
                        <option value="COAGMASTER BR">COAGMASTER BR</option>
                        <option disabled class="sub-header">--- URIAN√ÅLISE ---</option>
                        <option value="URIVISION 300">URIVISION 300</option>
                    </optgroup>
                    <optgroup label="FABRICANTE: ECO">
                        <option disabled class="sub-header">--- IMUNOLOGIA ---</option>
                        <option value="F100">F100</option>
                        <option value="F200">F200</option>
                    </optgroup>
                    <optgroup label="FABRICANTE: VIDA BIO">
                        <option disabled class="sub-header">--- URIAN√ÅLISE ---</option>
                        <option value="URIVIDA 500">URIVIDA 500</option>
                        <option value="URIVIDA 1000">URIVIDA 1000</option>
                    </optgroup>
                </select>
            </div>

            <div>
                <label>Consultor</label>
                <select id="consultantName">
                    <option value="" disabled selected>Selecione o Consultor</option>
                    <optgroup label="S√ÉO PAULO">
                        <option value="AILTON">AILTON</option>
                        <option value="ANDERSON">ANDERSON</option>
                        <option value="CARLOS">CARLOS</option>
                        <option value="LEANDRO EMIDIO">LEANDRO EMIDIO</option>
                        <option value="LUCIANA">LUCIANA</option>
                        <option value="MARCELO">MARCELO</option>
                        <option value="MARCIO BANDONI">MARCIO BANDONI</option>
                        <option value="REGIANE">REGIANE</option>
                        <option value="RICARDO">RICARDO</option>
                        <option value="SIDNEI">SIDNEI</option>
                        <option value="VALTER">VALTER</option>
                    </optgroup>
                    <optgroup label="MINAS GERAIS">
                        <option value="ANDRE">ANDRE</option>
                    </optgroup>
                    <optgroup label="GOI√ÅS">
                        <option value="FERNANDO">FERNANDO</option>
                    </optgroup>
                    <optgroup label="RIO GRANDE DO SUL">
                        <option value="LEANDRO OLIVEIRA">LEANDRO OLIVEIRA</option>
                    </optgroup>
                </select>
            </div>

            <div><label>Cliente</label><input type="text" id="clientName" placeholder="Ex: Hospital Einstein"></div>
            <div><label>Cidade</label><input type="text" id="clientCity" placeholder="Ex: S√£o Paulo"></div>
            <div><label>Ocorr√™ncia</label><input type="text" id="ocNum" placeholder="digite a OC" maxlength="5"
                    oninput="this.value=this.value.replace(/[^0-9]/g,'');"></div>
            <div><label>C√≥d. Cliente</label><input type="text" id="clientCod" placeholder="digite o c√≥digo"
                    maxlength="5" oninput="this.value=this.value.replace(/[^0-9]/g,'');"></div>
            <div>
                <label>Tipo de Contrato</label>
                <select id="contractType">
                    <option value="" disabled selected>Selecione o Tipo</option>
                    <option value="LOCA√á√ÉO">LOCA√á√ÉO</option>
                    <option value="VENDA">VENDA</option>
                    <option value="COMODATO">COMODATO</option>
                    <option value="EMPR√âSTIMO">EMPR√âSTIMO</option>
                    <option value="VALIDA√á√ÉO">VALIDA√á√ÉO</option>
                    <option value="LOCA√á√ÉO + PRESTA√á√ÉO DE SERVI√áO">LOCA√á√ÉO + PRESTA√á√ÉO DE SERVI√áO</option>
                    <option value="COMODATO + PRESTA√á√ÉO DE SERVI√áO">COMODATO + PRESTA√á√ÉO DE SERVI√áO</option>
                    <option value="PRESTA√á√ÉO DE SERVI√áO">PRESTA√á√ÉO DE SERVI√áO</option>
                </select>
            </div>
        </div>

        <div class="dates-grid">
            <div><label>Contrato Assinado:</label><input type="date" id="dateContract"></div>
            <div><label>In√≠cio do Processo:</label><input type="date" id="dateStart"></div>
            <div><label>Go Live Cliente:</label><input type="date" id="goLiveDate"></div>
        </div>

        <label class="sn-container-title">N√∫meros de S√©rie</label>
        <div class="sn-grid" id="snGrid"></div>

        <div class="btn-group">
            <button class="add-btn" id="btnAdd" onclick="window.addNewCardFromInput()">Adicionar Card</button>
            <button class="notify-btn" onclick="window.sendTeamAlert()">üîî Notificar Todos</button>
        </div>
    </div>

    <div class="filter-bar">
        <span style="font-weight:bold;">üîé Filtrar:</span>
        <input type="text" class="filter-input" id="searchBar" placeholder="Busque..." oninput="window.filterCards()">
        <select class="filter-select" id="filterStatus" onchange="window.filterCards()">
            <option value="TODOS">Todos os Status</option>
            <option value="URGENTE">‚ö†Ô∏è URGENTE (Prioridade)</option>
            <option value="NEGOCIA√á√ÉO">NEGOCIA√á√ÉO</option>
            <option value="MANUTEN√á√ÉO">MANUTEN√á√ÉO</option>
            <option value="TRANSPORTE">TRANSPORTE</option>
            <option value="INSTALA√á√ÉO">INSTALA√á√ÉO</option>
            <option value="TREINAMENTO">TREINAMENTO</option>
            <option value="FINALIZADO">FINALIZADO</option>
            <option value="LIXEIRA" style="color:red; font-weight:bold;">üóëÔ∏è LIXEIRA (ITENS APAGADOS)</option>
        </select>
        <span class="filter-count" id="cardCount">Mostrando: 0</span>
    </div>

    <div class="board-container" id="board"></div>
    <div id="toast">üîî Atualiza√ß√£o recebida!</div>

    <div class="modal-overlay" id="editModal">
        <div class="modal-box">
            <div class="modal-title">Editar Dados</div>
            <div class="modal-form-group"><label>Cliente</label><input type="text" id="modalClient"></div>
            <div class="modal-form-group"><label>Cidade</label><input type="text" id="modalCity"></div>
            <div class="modal-form-group"><label>Consultor</label><input type="text" id="modalConsultant"></div>
            <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:0; display:grid;">
                <div class="modal-form-group"><label>OC</label><input type="text" id="modalOc"></div>
                <div class="modal-form-group"><label>C√≥digo</label><input type="text" id="modalCod"></div>
            </div>
            <div class="modal-form-group"><label>Contrato</label><select id="modalContract">
                    <option value="LOCA√á√ÉO">LOCA√á√ÉO</option>
                    <option value="VENDA">VENDA</option>
                    <option value="COMODATO">COMODATO</option>
                    <option value="EMPR√âSTIMO">EMPR√âSTIMO</option>
                    <option value="VALIDA√á√ÉO">VALIDA√á√ÉO</option>
                    <option value="LOCA√á√ÉO + PRESTA√á√ÉO DE SERVI√áO">LOCA√á√ÉO + PRESTA√á√ÉO DE SERVI√áO</option>
                    <option value="COMODATO + PRESTA√á√ÉO DE SERVI√áO">COMODATO + PRESTA√á√ÉO DE SERVI√áO</option>
                    <option value="PRESTA√á√ÉO DE SERVI√áO">PRESTA√á√ÉO DE SERVI√áO</option>
                </select></div>
            <div class="modal-form-group"><label>M√°quina</label><input type="text" id="modalMachine" readonly
                    style="background:#eee; color:#666;"></div>
            <div class="modal-form-group"><label>N√∫meros de S√©rie</label><input type="text" id="modalSn"></div>
            <div class="modal-actions"><button class="btn-modal-cancel"
                    onclick="window.closeEditModal()">Cancelar</button><button class="btn-modal-save"
                    onclick="window.saveEditModal()">Salvar Altera√ß√µes</button></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc }
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA3Xg_0LLGDVeRv5jVGnSFESc8I4Z1fsA8",
            authDomain: "projeto-atellica.firebaseapp.com",
            projectId: "projeto-atellica",
            storageBucket: "projeto-atellica.firebasestorage.app",
            messagingSenderId: "422526536640",
            appId: "1:422526536640:web:0afcb40f3e79ccf93e9625"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const boardRef = doc(db, "scrum_board", "siemens_db_oficial");

        // --- CONFIGURA√á√ÉO DE DESTINAT√ÅRIOS (EDITAR AQUI) ---
        // A chave (texto √† esquerda) deve ser ID√äNTICA ao nome no checklist
        const contactsDB = {
            "NOTA FISCAL EQUIPAMENTO": {
                phone: "5511988133963", email: "rayan@calibralab.com.br", role: "Faturamento Equipamento"
            },
            "CHECK LIST HIDR√ÅULICA": {
                phone: "5511988133963", email: "eduardo@calibralab.com.br", role: "Engenharia"
            },
            "PEDIDO DOS ITENS DO ATP": {
                phone: "5511947684602", email: "marcio@centerlabsp.com.br", role: "Suprimentos Atellica"
            },
            "PEDIDO ITENS VALIDA√á√ÉO": {
                phone: "5511947684602", email: "marcio@centerlabsp.com.br", role: "Suprimentos Gerais"
            },
            "TRANSPORTE EQUIPAMENTO": {
                phone: "5511996670218", email: "gilson@centerlabsp.com.br", role: "Log√≠stica"
            },
            "NOTIFICAR FINANCEIRO": {
                phone: "5511994186487", email: "jeniffer@centerlabsp.com.br", role: "Financeiro"
            }
        };

        const atellicaConfig = { "ATELLICA SC": ["ATELLICA SH", "ATELLICA CH"], "ATELLICA SCI": ["ATELLICA SH", "ATELLICA CH", "ATELLICA IM"], "ATELLICA SI": ["ATELLICA SH", "ATELLICA IM"], "ATELLICA SCCI": ["ATELLICA SH", "ATELLICA CH (1)", "ATELLICA CH (2)", "ATELLICA IM"], "ATELLICA SCII": ["ATELLICA SH", "ATELLICA CH", "ATELLICA IM (1)", "ATELLICA IM (2)"] };
        const statusOptions = ["NEGOCIA√á√ÉO", "MANUTEN√á√ÉO", "TRANSPORTE", "INSTALA√á√ÉO", "TREINAMENTO", "FINALIZADO"];
        const locationOptions = ["Selecione o Local", "Calibra SP", "Calibra RP", "Centerlab RS", "Calibra SCS"];

        // CHECKLIST ATUALIZADO V70
        const checklistAtellica = ["CONTATO DO CLIENTE", "CHECK LIST HIDR√ÅULICA", "CHECK LIST EL√âTRICA", "CHECK LIST PLANTA BAIXA", "CHECK LIST DE ACESS√ìRIOS DO EQUIPAMENTO", "COMPUTADOR ACM", "SOFTWARE ACM", "PEDIDO DOS ITENS DO ATP", "PEDIDO DOS ITENS DO CLIENTE", "TRANSPORTE EQUIPAMENTO", "NOTA FISCAL EQUIPAMENTO", "NOTA FISCAL NO-BREAK", "NOTA FISCAL ESTA√á√ÉO DE √ÅGUA", "INSTALA√á√ÉO ACM", "INSTALA√á√ÉO ATELLICA", "INSTALA√á√ÉO ESTA√á√ÉO DE √ÅGUA", "ENTREGA DOS ITENS DO ATP", "REALIZA√á√ÉO PR√â ATP", "REALIZA√á√ÉO DO ATP", "ENTREGA DOS ITENS DO CLIENTE", "TREINAMENTO", "NOTIFICAR FINANCEIRO", "P√ìS VENDA", "CERTIFICADO DE TREINAMENTO"];

        // CHECKLIST GERAL ATUALIZADO V70
        const checklistGeneral = ["CONTATO DO CLIENTE", "CHECK LIST HIDR√ÅULICA", "CHECK LIST EL√âTRICA", "CHECK LIST PLANTA BAIXA", "CHECK LIST DE ACESS√ìRIOS DO EQUIPAMENTO", "PEDIDO ITENS VALIDA√á√ÉO", "PEDIDO DOS ITENS DO CLIENTE", "ENTREGA DOS ITENS DO CLIENTE", "TRANSPORTE EQUIPAMENTO", "NOTA FISCAL EQUIPAMENTO", "NOTA FISCAL NO-BREAK", "NOTA FISCAL ESTA√á√ÉO DE √ÅGUA", "INSTALA√á√ÉO EQUIPAMENTO", "INSTALA√á√ÉO ESTA√á√ÉO DE √ÅGUA", "TREINAMENTO", "NOTIFICAR FINANCEIRO", "P√ìS VENDA", "CERTIFICADO DE TREINAMENTO"];

        const techStatusMap = {
            'DEMANDAS': { label: 'AGUARDANDO T√âCNICO', color: '#6c757d' },
            'REPARO': { label: 'EM REPARO', color: '#fd7e14' },
            'VAL_TEC': { label: 'VAL. T√âCNICA', color: '#ffc107' },
            'VAL_CIEN': { label: 'VAL. CIENT√çFICA', color: '#0dcaf0' },
            'VISTORIA': { label: 'VISTORIA FINAL', color: '#0d6efd' },
            'EMBALAGEM': { label: 'EMBALAGEM', color: '#6f42c1' },
            'PRONTO': { label: 'PRONTO', color: '#198754' }
        };

        const board = document.getElementById('board');
        const statusInd = document.getElementById('status-indicator');
        let currentCardsData = [];
        let isFirstLoad = true;
        let lastAlertTimestamp = 0;
        let currentEditingId = null;
        let editingCommentId = null;

        window.updateSnFields = function () {
            const selectedMachine = document.getElementById('machineType').value;
            const snGrid = document.getElementById('snGrid');
            snGrid.innerHTML = '';
            if (selectedMachine && atellicaConfig[selectedMachine]) {
                atellicaConfig[selectedMachine].forEach((mod) => {
                    const div = document.createElement('div'); div.className = 'sn-field-group';
                    div.innerHTML = `<span class="sn-label-dynamic">S/N ${mod}</span><input type="text" class="sn-input-dynamic" data-label="${mod}" placeholder="Digite...">`;
                    snGrid.appendChild(div);
                });
            } else {
                const div = document.createElement('div'); div.className = 'sn-field-group';
                div.innerHTML = `<span class="sn-label-dynamic">N√∫mero de S√©rie</span><input type="text" class="sn-input-dynamic" data-label="S/N" placeholder="Digite o S/N...">`;
                snGrid.appendChild(div);
            }
        }
        window.updateSnFields();

        function playNotificationSound() { try { const ctx = new (window.AudioContext || window.webkitAudioContext)(); const osc = ctx.createOscillator(); const gain = ctx.createGain(); osc.connect(gain); gain.connect(ctx.destination); osc.type = 'sine'; osc.frequency.setValueAtTime(600, ctx.currentTime); osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1); gain.gain.setValueAtTime(0.1, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5); osc.start(); osc.stop(ctx.currentTime + 0.5); } catch (e) { } }
        function showToast(message) { const x = document.getElementById("toast"); x.innerText = message || "üîî Atualiza√ß√£o recebida!"; x.className = "show"; setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000); }

        window.filterCards = function () {
            const searchText = document.getElementById('searchBar').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            let visibleCount = 0;
            document.querySelectorAll('.card').forEach(card => {
                const isDeleted = card.getAttribute('data-deleted') === 'true';
                const isUrgent = card.getAttribute('data-urgent') === 'true';
                const text = (card.getAttribute('data-client') + card.getAttribute('data-city') + card.getAttribute('data-machine') + card.getAttribute('data-sn')).toLowerCase();
                const status = card.querySelector('.status-select').value;
                let matchesStatus = false;
                if (statusFilter === "LIXEIRA") matchesStatus = isDeleted;
                else if (statusFilter === "URGENTE") matchesStatus = !isDeleted && isUrgent;
                else matchesStatus = !isDeleted && (statusFilter === "TODOS" || status === statusFilter);
                if (text.includes(searchText) && matchesStatus) { card.style.display = "block"; visibleCount++; } else { card.style.display = "none"; }
            });
            document.getElementById('cardCount').innerText = `Mostrando: ${visibleCount}`;
        }

        onSnapshot(boardRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                currentCardsData = data.cards || [];
                const alertTime = data.alertTrigger || 0;
                if (alertTime > lastAlertTimestamp && lastAlertTimestamp !== 0) { playNotificationSound(); showToast("‚ö†Ô∏è ATEN√á√ÉO: EQUIPE CHAMANDO!"); }
                if (lastAlertTimestamp === 0) lastAlertTimestamp = alertTime; else lastAlertTimestamp = Math.max(lastAlertTimestamp, alertTime);
                statusInd.innerText = "Online üü¢"; statusInd.style.color = "green";
                renderBoard(currentCardsData); filterCards();
                isFirstLoad = false;
            } else { setDoc(boardRef, { cards: [], alertTrigger: 0 }); statusInd.innerText = "Criando banco de dados..."; }
        }, (err) => { console.error(err); statusInd.innerText = "Erro Conex√£o üî¥"; statusInd.style.color = "red"; });

        const escapeAttr = (str) => String(str).replace(/'/g, "\\'").replace(/"/g, "&quot;");

        // --- FUN√á√ÉO PARA GERAR BOT√ïES DE A√á√ÉO ---
        function getActionButtons(stage, cardData) {
            if (!contactsDB[stage]) return '';

            const contact = contactsDB[stage];
            const msgBody = `Ol√° ${contact.role}, favor verificar: *${stage}*.\nCliente: *${cardData.client}*\nEquipamento: *${cardData.machine}*\nS/N: ${cardData.serialsText}`;
            const waLink = `https://wa.me/${contact.phone}?text=${encodeURIComponent(msgBody)}`;
            const mailLink = `mailto:${contact.email}?subject=${encodeURIComponent("Checklist Centerlab: " + stage + " - " + cardData.client)}&body=${encodeURIComponent(msgBody)}`;

            return `
                <div class="action-icon-group">
                    <a href="${waLink}" target="_blank" class="btn-msg-tiny btn-whatsapp" title="Enviar WhatsApp">üì±</a>
                    <a href="${mailLink}" target="_blank" class="btn-msg-tiny btn-email" title="Enviar E-mail">üìß</a>
                </div>
            `;
        }

        window.addComment = function (cardId) {
            const card = document.getElementById(cardId);
            const textIn = card.querySelector('.comment-input-text');
            const stage = card.querySelector('.stage-select').value;
            const module = card.querySelector('.module-select').value;
            const text = textIn.value.trim();
            if (!text) return;

            const cardIndex = currentCardsData.findIndex(c => c.id === cardId);
            if (cardIndex === -1) return;

            if (editingCommentId) {
                const commentIndex = currentCardsData[cardIndex].comments.findIndex(c => (typeof c === 'object' ? c.id : c) === editingCommentId);
                if (commentIndex > -1) {
                    currentCardsData[cardIndex].comments[commentIndex] = {
                        id: editingCommentId, text: text, stage: stage, module: module,
                        time: new Date().toLocaleString('pt-BR') + ' (Editado)'
                    };
                }
                editingCommentId = null;
            } else {
                const newComment = { id: 'cm-' + Date.now(), text: text, stage: stage, module: module, time: new Date().toLocaleString('pt-BR') };
                if (!Array.isArray(currentCardsData[cardIndex].comments)) currentCardsData[cardIndex].comments = [];
                currentCardsData[cardIndex].comments.push(newComment);
            }
            textIn.value = '';
            saveToCloud(); playNotificationSound(); showToast("Salvo! üíæ");
        }

        window.editComment = function (cardId, commentId) {
            const cardData = currentCardsData.find(c => c.id === cardId);
            const comment = cardData.comments.find(c => (typeof c === 'object' ? c.id : c) === commentId);
            const cardEl = document.getElementById(cardId);
            const input = cardEl.querySelector('.comment-input-text');
            if (typeof comment === 'string') { input.value = comment; }
            else if (comment) {
                input.value = comment.text;
                const stageSel = cardEl.querySelector('.stage-select');
                const modSel = cardEl.querySelector('.module-select');
                if (stageSel.querySelector(`option[value="${comment.stage}"]`)) stageSel.value = comment.stage;
                if (modSel.querySelector(`option[value="${comment.module}"]`)) modSel.value = comment.module;
            }
            editingCommentId = commentId;
            input.focus();
        }

        window.deleteComment = function (cardId, commentId) {
            const idx = currentCardsData.findIndex(c => c.id === cardId);
            if (idx > -1) {
                currentCardsData[idx].comments = currentCardsData[idx].comments.filter(c => {
                    if (typeof c === 'string') return c !== commentId;
                    return c.id !== commentId;
                });
                saveToCloud();
            }
        }

        window.openEditModal = function (id) {
            const card = currentCardsData.find(c => c.id === id); if (!card) return;
            currentEditingId = id;
            document.getElementById('modalClient').value = card.client || '';
            document.getElementById('modalCity').value = card.city || '';
            document.getElementById('modalConsultant').value = card.consultant || '';
            document.getElementById('modalOc').value = card.oc || '';
            document.getElementById('modalCod').value = card.cod || '';
            document.getElementById('modalContract').value = card.contract || 'LOCA√á√ÉO';
            document.getElementById('modalMachine').value = card.machine || '';
            document.getElementById('modalSn').value = card.serialsText || '';
            document.getElementById('editModal').style.display = 'flex';
        }

        window.closeEditModal = function () { document.getElementById('editModal').style.display = 'none'; currentEditingId = null; }

        window.saveEditModal = function () {
            if (!currentEditingId) return;
            const idx = currentCardsData.findIndex(c => c.id === currentEditingId);
            if (idx > -1) {
                currentCardsData[idx].client = document.getElementById('modalClient').value;
                currentCardsData[idx].city = document.getElementById('modalCity').value;
                currentCardsData[idx].consultant = document.getElementById('modalConsultant').value;
                currentCardsData[idx].oc = document.getElementById('modalOc').value;
                currentCardsData[idx].cod = document.getElementById('modalCod').value;
                currentCardsData[idx].contract = document.getElementById('modalContract').value;
                currentCardsData[idx].serialsText = document.getElementById('modalSn').value;
                renderBoard(currentCardsData); saveToCloud(); closeEditModal(); showToast("Dados atualizados! üíæ");
            }
        }

        window.handleCheckboxClick = function (cardId) {
            const card = currentCardsData.find(c => c.id === cardId);
            if (card) {
                // Ao clicar, recalcula estado para pintar borda imediatamente se necess√°rio
                const today = new Date().toISOString().split('T')[0];
                const isLate = (card.dateGoLive && card.dateGoLive < today && card.statusVal !== 'FINALIZADO');
                const isFinished = (card.statusVal === 'FINALIZADO');

                updateProgress(cardId, isLate, isFinished);
                markCardUpdated(cardId);
            }
            playNotificationSound();
            showToast("Atualizado!");
        }

        window.markCardUpdated = function (cardId) {
            const card = document.getElementById(cardId);
            if (card) {
                const now = new Date().toLocaleString('pt-BR');
                const label = card.querySelector('.last-updated span');
                if (label) label.innerText = now;
                const idx = currentCardsData.findIndex(c => c.id === cardId); if (idx > -1) currentCardsData[idx].lastUpdated = now;
                window.saveToCloud();
            }
        }

        window.saveToCloud = async function () {
            statusInd.innerText = "Salvando... üü†";
            document.querySelectorAll('.card').forEach(card => {
                const id = card.id;
                const idx = currentCardsData.findIndex(c => c.id === id);
                if (idx > -1) {
                    currentCardsData[idx].statusVal = card.querySelector('.status-select').value;
                    currentCardsData[idx].dateContract = card.querySelector('.date-contract').value;
                    currentCardsData[idx].dateStart = card.querySelector('.date-start').value;
                    currentCardsData[idx].locManut = card.querySelector('.loc-manut').value;
                    currentCardsData[idx].datePrevInst = card.querySelector('.date-prev-inst').value;
                    currentCardsData[idx].dateGoLive = card.querySelector('.date-golive').value;
                    currentCardsData[idx].isUrgent = card.querySelector('.urgent-check').checked;
                    const checkedIndices = [];
                    card.querySelectorAll('.checklist input[type="checkbox"]').forEach((cb, index) => { if (cb.checked) checkedIndices.push(index); });
                    currentCardsData[idx].checkedIndices = checkedIndices;

                    const acm = card.querySelector('.acm-sn'); if (acm) currentCardsData[idx].acmSnValue = acm.value;
                    const cont = card.querySelector('.contact-input'); if (cont) currentCardsData[idx].contactValue = cont.value;
                    const tran = card.querySelector('.transp-input'); if (tran) currentCardsData[idx].transpValue = tran.value;

                    const d_atel = card.querySelector('.date-atellica-lib'); if (d_atel) currentCardsData[idx].atellicaLib = d_atel.value;
                    const d_ent = card.querySelector('.date-entregaatp-lib'); if (d_ent) currentCardsData[idx].entregaAtpLib = d_ent.value;
                    const d_pre = card.querySelector('.date-preatp-lib'); if (d_pre) currentCardsData[idx].preAtpLib = d_pre.value;
                    const d_atp = card.querySelector('.date-atp-lib'); if (d_atp) currentCardsData[idx].atpLib = d_atp.value;

                    const d_fin = card.querySelector('.date-financeiro'); if (d_fin) currentCardsData[idx].financeNotifDate = d_fin.value;
                    const d_val = card.querySelector('.date-validacao'); if (d_val) currentCardsData[idx].validationItemsDate = d_val.value;
                }
            });
            try { await updateDoc(boardRef, { cards: currentCardsData }); } catch (e) { console.error(e); statusInd.innerText = "Erro ao salvar!"; }
        }

        window.sendTeamAlert = async function () { const now = Date.now(); await updateDoc(boardRef, { alertTrigger: now }); playNotificationSound(); }

        window.addNewCardFromInput = function () {
            const machine = document.getElementById('machineType').value; const client = document.getElementById('clientName').value;
            const consultant = document.getElementById('consultantName').value; // CONSULTOR

            if (!machine || !client) { alert("Preencha M√°quina e Cliente."); return; }
            let snParts = []; document.querySelectorAll('.sn-input-dynamic').forEach(input => { if (input.value.trim() !== "") { const label = input.getAttribute('data-label').replace('ATELLICA ', ''); snParts.push(label === 'S/N' ? input.value.trim() : `${label}: ${input.value.trim()}`); } }); const serialsText = snParts.length > 0 ? snParts.join(' | ') : '---';

            const newCard = { id: 'card-' + Date.now(), machine, client, consultant, city: document.getElementById('clientCity').value, oc: document.getElementById('ocNum').value, cod: document.getElementById('clientCod').value, contract: document.getElementById('contractType').value, serialsText, statusVal: 'NEGOCIA√á√ÉO', dateContract: document.getElementById('dateContract').value, dateStart: document.getElementById('dateStart').value, dateGoLive: document.getElementById('goLiveDate').value, locManut: '', datePrevInst: '', checkedIndices: [], comments: [], lastUpdated: new Date().toLocaleString('pt-BR'), acmSnValue: '', contactValue: '', transpValue: '', atellicaLib: '', entregaAtpLib: '', preAtpLib: '', atpLib: '', financeNotifDate: '', validationItemsDate: '', isUrgent: false, isDeleted: false };
            currentCardsData.push(newCard);

            document.getElementById('clientName').value = '';
            document.getElementById('clientCity').value = '';
            document.getElementById('ocNum').value = '';
            document.getElementById('clientCod').value = '';
            document.getElementById('dateContract').value = '';
            document.getElementById('dateStart').value = '';
            document.getElementById('goLiveDate').value = '';
            document.getElementById('contractType').selectedIndex = 0;
            document.getElementById('machineType').selectedIndex = 0;
            document.getElementById('consultantName').selectedIndex = 0;
            document.querySelectorAll('.sn-input-dynamic').forEach(i => i.value = '');
            window.updateSnFields();

            renderBoard(currentCardsData); filterCards(); window.saveToCloud();
        }

        window.moveToTrash = function (id) { if (confirm('Mover para Lixeira?')) { currentCardsData.find(c => c.id === id).isDeleted = true; renderBoard(currentCardsData); filterCards(); saveToCloud(); } }
        window.restoreCard = function (id) { currentCardsData.find(c => c.id === id).isDeleted = false; renderBoard(currentCardsData); filterCards(); saveToCloud(); }
        window.permanentDelete = function (id) { if (confirm('APAGAR DEFINITIVAMENTE?')) { currentCardsData = currentCardsData.filter(c => c.id !== id); renderBoard(currentCardsData); filterCards(); saveToCloud(); } }

        window.updateProgress = function (cardId, isLate, isFinished) {
            const card = document.getElementById(cardId); if (!card) return; const cb = card.querySelectorAll('.checklist input[type="checkbox"]'); const pct = Math.round((Array.from(cb).filter(c => c.checked).length / cb.length) * 100);
            const pb = document.getElementById(`progress-${cardId}`); pb.style.width = pct + '%'; pb.innerText = pct + '%'; if (pct <= 25) pb.style.backgroundColor = '#dc3545'; else if (pct <= 50) pb.style.backgroundColor = '#ffc107'; else if (pct <= 75) pb.style.backgroundColor = '#17a2b8'; else pb.style.backgroundColor = '#28a745'; pb.style.color = (pct > 25 && pct <= 50) ? '#333' : '#fff';

            // L√ìGICA DE BORDA (V72)
            card.style.border = "none"; // Reseta borda total
            card.style.borderTop = "5px solid"; // Mant√©m estilo base do topo

            if (isFinished) {
                // BORDA TOTAL VERDE
                card.style.border = "4px solid #28a745";
            } else if (isLate) {
                // BORDA TOTAL VERMELHA
                card.style.border = "4px solid #dc3545";
            } else {
                // CORES PADR√ÉO (S√ì TOPO)
                const status = card.querySelector('.status-select').value;
                if (status === 'NEGOCIA√á√ÉO') card.style.borderTopColor = '#0056b3';
                else if (status === 'MANUTEN√á√ÉO') card.style.borderTopColor = '#fd7e14';
                else if (status === 'TRANSPORTE') card.style.borderTopColor = '#6f42c1';
                else if (status === 'INSTALA√á√ÉO') card.style.borderTopColor = '#ffc107';
                else if (status === 'TREINAMENTO') card.style.borderTopColor = '#20c997';
                else if (status === 'FINALIZADO') card.style.borderTopColor = '#28a745';
            }
        }

        function renderBoard(cards) {
            // ORDENA√á√ÉO INTELIGENTE (V72)
            const today = new Date().toISOString().split('T')[0];

            cards.sort((a, b) => {
                const isLateA = (a.dateGoLive && a.dateGoLive < today && a.statusVal !== 'FINALIZADO');
                const isLateB = (b.dateGoLive && b.dateGoLive < today && b.statusVal !== 'FINALIZADO');

                if (isLateA && !isLateB) return -1; // A sobe (Vermelho Prioridade)
                if (!isLateA && isLateB) return 1;  // B sobe

                if (a.isUrgent && !b.isUrgent) return -1;
                if (!a.isUrgent && b.isUrgent) return 1;

                const d1 = new Date(a.dateContract || '9999-12-31');
                const d2 = new Date(b.dateContract || '9999-12-31');
                return d1 - d2;
            });

            const board = document.getElementById('board'); board.innerHTML = '';

            cards.forEach(data => {
                const card = document.createElement('div'); card.className = `card ${data.isDeleted ? 'deleted-card' : ''}`; card.id = data.id;
                card.setAttribute('data-client', data.client || ''); card.setAttribute('data-city', data.city || ''); card.setAttribute('data-machine', data.machine || ''); card.setAttribute('data-sn', data.serialsText || ''); card.setAttribute('data-urgent', data.isUrgent); card.setAttribute('data-deleted', data.isDeleted);

                const statusOptionsHTML = statusOptions.map(opt => `<option value="${opt}" ${data.statusVal === opt ? 'selected' : ''}>${opt}</option>`).join('');
                const locOptionsHTML = locationOptions.map(opt => `<option value="${opt}" ${data.locManut === opt ? 'selected' : ''}>${opt}</option>`).join('');
                let listToUse = checklistGeneral; const isAtellica = atellicaConfig.hasOwnProperty(data.machine); if (isAtellica) listToUse = checklistAtellica;

                // --- AQUI EST√Å A ALTERA√á√ÉO PARA INCLUIR "COMERCIAL" NO TOPO ---
                const stageSelectHTML = `<option value="COMERCIAL" style="font-weight:bold; color:#0056b3;">üì¢ OBSERVA√á√ÉO COMERCIAL</option>` +
                    listToUse.map(s => `<option value="${s}">${s}</option>`).join('');

                let moduleOptions = ["Geral"]; if (isAtellica) moduleOptions = ["Geral", ...atellicaConfig[data.machine].map(m => m.replace('ATELLICA ', ''))];
                const moduleSelectHTML = moduleOptions.map(m => `<option value="${m}">${m}</option>`).join('');
                const urgentBadge = data.isUrgent ? `<span class="badge urgent-badge">URGENTE</span>` : '';

                const consultantBadge = data.consultant ? `<span class="consultant-badge">${data.consultant}</span>` : '';
                const techStatus = data.technicalStatus || 'DEMANDAS';
                const techLabel = techStatusMap[techStatus] || techStatusMap['DEMANDAS'];
                const techBadgeHTML = `<div class="tech-status-label" style="color:${techLabel.color}; border-color:${techLabel.color}; margin-bottom:5px;">[OFICINA: ${techLabel.label}]</div>`;

                const comments = Array.isArray(data.comments) ? data.comments : [];
                const commentsHTML = comments.map(c => {
                    let text = '', meta = '', time = '', id = '';
                    if (typeof c === 'string') { text = c; id = c; }
                    else { text = c.text; id = c.id; time = c.time; meta = `<span class="comment-meta">[${c.stage}] - (${c.module})</span>`; }
                    const safeId = escapeAttr(id);
                    return `<li class="comment-item"><div class="comment-header">${meta} <span class="comment-time">${time}</span></div><div class="comment-body"><span class="comment-text">${text}</span><div class="comment-actions"><button class="comment-action-btn" onclick="editComment('${data.id}', '${safeId}')" title="Editar">‚úé</button><button class="comment-action-btn" onclick="deleteComment('${data.id}', '${safeId}')" title="Excluir">‚ùå</button></div></div></li>`;
                }).join('');

                let topBtns = data.isDeleted ? `<button class="action-btn btn-restore" onclick="restoreCard('${data.id}')">‚ôªÔ∏è</button><button class="action-btn btn-perm-delete" onclick="permanentDelete('${data.id}')">üóëÔ∏è</button>` : `<button class="action-btn btn-edit" onclick="openEditModal('${data.id}')">‚úé</button><button class="action-btn btn-trash" onclick="moveToTrash('${data.id}')">√ó</button>`;

                card.innerHTML = `
                    <div class="card-actions-top">${topBtns}</div>
                    <div class="card-header-area">
                        <div class="card-top-flex">
                            <div class="card-client">${data.client}</div>
                            <div class="card-badges">
                                ${consultantBadge} <span class="badge">${data.contract || '---'}</span>
                                <span class="badge">OC: ${data.oc || '---'}</span>
                                <span class="badge">C√≥d: ${data.cod || '---'}</span>
                                ${urgentBadge}
                            </div>
                        </div>
                        <div class="card-city">${data.city || '---'}</div>
                        <div class="card-machine-row"><span class="card-machine-name">${data.machine}</span><div class="urgent-wrapper"><input type="checkbox" class="urgent-check" ${data.isUrgent ? 'checked' : ''} onchange="markCardUpdated('${data.id}'); renderBoard(currentCardsData);"><label class="urgent-label" onclick="this.previousElementSibling.click()">URGENTE</label></div></div>
                        <div class="card-sn-badge">S/N: ${data.serialsText}</div>
                        ${techBadgeHTML}
                    </div>
                    <div class="negotiation-box"><select class="status-select" onchange="markCardUpdated('${data.id}'); renderBoard(currentCardsData);">${statusOptionsHTML}</select>
                        <div class="negotiation-body">
                            <div class="neg-row"><span class="neg-label">Contrato Assinado:</span><input type="date" class="neg-input date-contract" value="${data.dateContract || ''}" onchange="markCardUpdated('${data.id}');"></div>
                            <div class="neg-row"><span class="neg-label">In√≠cio do Processo:</span><input type="date" class="neg-input date-start" value="${data.dateStart || ''}" onchange="markCardUpdated('${data.id}')"></div>
                            <div class="neg-row"><span class="neg-label">Local da Manuten√ß√£o:</span><select class="neg-input loc-manut" onchange="markCardUpdated('${data.id}')">${locOptionsHTML}</select></div>
                            <div class="neg-row"><span class="neg-label">Previs√£o de Instala√ß√£o:</span><input type="date" class="neg-input date-prev-inst" value="${data.datePrevInst || ''}" onchange="markCardUpdated('${data.id}')"></div>
                            <div class="neg-row"><span class="neg-label">Go Live Cliente:</span><input type="date" class="neg-input date-golive" value="${data.dateGoLive || ''}" onchange="markCardUpdated('${data.id}'); renderBoard(currentCardsData);"></div>
                        </div>
                    </div>
                    <div class="last-updated">Ult. Atualiza√ß√£o: <span>${data.lastUpdated || '---'}</span></div>
                    <div class="progress-container"><div class="progress-bar" id="progress-${data.id}">0%</div></div>
                    <div class="checklist">
                        ${listToUse.map((stage, index) => {
                    let extra = '';
                    if (isAtellica) {
                        if (stage === "CONTATO DO CLIENTE") extra = `<input type="text" class="checklist-input-text-soft contact-input" placeholder="Nome/Tel" value="${data.contactValue || ''}" onchange="markCardUpdated('${data.id}')" onclick="event.stopPropagation()">`;
                        else if (stage === "SOFTWARE ACM") extra = `<input type="text" class="checklist-input-text-soft acm-sn" placeholder="Digite o S/N" value="${data.acmSnValue || ''}" onchange="markCardUpdated('${data.id}')" onclick="event.stopPropagation()">`;
                        else if (["ENTREGA DOS ITENS DO ATP", "REALIZA√á√ÉO PR√â ATP", "REALIZA√á√ÉO DO ATP"].includes(stage)) {
                            let val = ''; if (stage.includes("ENTREGA")) val = data.entregaAtpLib; if (stage.includes("PR√â")) val = data.preAtpLib; if (stage.includes("REALIZA√á√ÉO DO ATP")) val = data.atpLib;
                            extra = `<span class="checklist-date-label">Previs√£o:</span><input type="date" class="checklist-date-inline ${stage.includes('ENTREGA') ? 'date-entregaatp-lib' : stage.includes('PR√â') ? 'date-preatp-lib' : 'date-atp-lib'}" value="${val || ''}" onchange="markCardUpdated('${data.id}')" onclick="event.stopPropagation()">`;
                        }
                    } else {
                        if (stage === "CONTATO DO CLIENTE") extra = `<input type="text" class="checklist-input-text-soft contact-input" placeholder="Nome/Tel" value="${data.contactValue || ''}" onchange="markCardUpdated('${data.id}')" onclick="event.stopPropagation()">`;
                        else if (stage === "TRANSPORTE EQUIPAMENTO") extra = `<input type="text" class="checklist-input-text-soft transp-input" placeholder="Info..." value="${data.transpValue || ''}" onchange="markCardUpdated('${data.id}')" onclick="event.stopPropagation()">`;
                    }
                    if (stage === "NOTIFICAR FINANCEIRO") {
                        extra = `<span class="checklist-date-label">Data:</span><input type="date" class="checklist-date-inline date-financeiro" value="${data.financeNotifDate || ''}" onchange="markCardUpdated('${data.id}')" onclick="event.stopPropagation()">`;
                    }
                    if (stage === "PEDIDO ITENS VALIDA√á√ÉO") {
                        extra = `<span class="checklist-date-label">Data:</span><input type="date" class="checklist-date-inline date-validacao" value="${data.validationItemsDate || ''}" onchange="markCardUpdated('${data.id}')" onclick="event.stopPropagation()">`;
                    }
                    const actions = getActionButtons(stage, data);
                    return `<div class="checklist-item"><input type="checkbox" ${data.checkedIndices.includes(index) ? 'checked' : ''} onchange="handleCheckboxClick('${data.id}')"> <label>${stage}</label>${extra}${actions}</div>`;
                }).join('')}
                    </div>
                    <div class="comments-section">
                        <div class="comment-form-grid"><select class="comment-select stage-select">${stageSelectHTML}</select><select class="comment-select module-select">${moduleSelectHTML}</select></div>
                        <div class="comment-input-row"><input type="text" class="comment-input-text" placeholder="Escreva o detalhe..." id="comment-input-${data.id}"><button class="comment-btn-save" onclick="addComment('${data.id}')">üíæ</button></div>
                        <ul class="comment-list" id="comments-${data.id}">${commentsHTML}</ul>
                    </div>`;
                board.appendChild(card);

                // CALCULA SE EST√Å ATRASADO PARA PINTAR A BORDA
                const isLate = (data.dateGoLive && data.dateGoLive < today && data.statusVal !== 'FINALIZADO');
                const isFinished = (data.statusVal === 'FINALIZADO');

                window.updateProgress(data.id, isLate, isFinished);
            });
        }
    </script>
</body>

</html>