<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Agendamentos - CenterlabSP</title>
    <link rel="icon" type="image/png" href="icone.png">
    
    <style>
        /* --- ESTILOS GERAIS --- */
        :root { --bg-color: #f4f5f7; --card-bg: #ffffff; --primary: #005f87; --text-color: #333; --border-radius: 6px; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 10px; padding-bottom: 80px; font-size: 12px; }
        
        /* HEADER: Logo Esquerda, T√≠tulo Centro */
        .header-container { display: flex; align-items: center; justify-content: center; margin-bottom: 15px; position: relative; height: 50px; }
        .header-logo { position: absolute; left: 10px; max-height: 45px; width: auto; top: 50%; transform: translateY(-50%); }
        h1 { text-align: center; color: var(--primary); font-size: 2.2em; font-weight: 900; text-transform: uppercase; margin: 0; letter-spacing: 1px; width: 100%; }
        
        /* BOT√ïES DO CABE√áALHO (Direita) */
        .nav-group { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); display: flex; gap: 10px; }
        .nav-btn { background-color: #005f87; color: white; padding: 8px 12px; text-decoration: none; border-radius: 5px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.2s; font-size: 13px; border: none; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .nav-btn:hover { background-color: #004b6b; }
        .nav-btn.stats-btn { background-color: #ffc107; color: #333; }
        .nav-btn.stats-btn:hover { background-color: #e0a800; }

        .control-panel { background: var(--card-bg); padding: 12px; border-radius: var(--border-radius); box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; max-width: 1400px; margin-left: auto; margin-right: auto; }
        
        .header-grid { display: grid; grid-template-columns: 200px 80px 1fr 1fr 180px 180px; gap: 8px; margin-bottom: 8px; align-items: end; }
        .dates-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 8px; margin-bottom: 8px; }
        
        input, select, textarea { padding: 3px 6px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 12px; height: 28px; background-color: #fff; }
        textarea { height: 28px; resize: none; font-family: inherit; }
        
        #machineType, #serviceRegion, #serviceType { font-size: 11px; }
        select { background-color: #f9f9f9; }
        label { font-weight: 700; font-size: 0.85em; display: block; margin-bottom: 2px; color: #333; }
        
        optgroup { font-weight: 800; color: #004085; background: #eef6fc; }
        option.sub-header { background: #ddd; color: #555; font-weight: bold; font-style: italic; font-size: 0.95em; }
        option { background: #fff; color: #333; padding-left: 10px; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        button.add-btn { background-color: #0056b3; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 13px; flex: 3; padding: 8px; }
        
        .filter-bar { display: flex; gap: 10px; margin-bottom: 10px; max-width: 1400px; margin-left: auto; margin-right: auto; background: #e9ecef; padding: 6px; border-radius: 6px; align-items: center; }
        .filter-input { flex: 2; height: 28px; } .filter-count { font-weight: bold; color: #666; font-size: 11px; }

        /* --- FILTRO DE ETIQUETAS (REGi√ÉO) - AJUSTADO PARA 13" --- */
        .tag-filter-bar { display: flex; flex-wrap: wrap; gap: 4px; max-width: 1400px; margin: 0 auto 15px auto; padding: 0 5px; align-items: center; }
        .tag-btn { 
            border: 1px solid #ccc; background: white; color: #555; 
            padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 700; cursor: pointer; transition: 0.2s; text-transform: uppercase; white-space: nowrap;
        }
        .tag-btn:hover { background: #f0f0f0; }
        .tag-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        @media (max-width: 900px) { 
            .header-grid, .dates-grid { grid-template-columns: 1fr; gap: 8px; } 
            .header-container { flex-direction: column; text-align: center; height: auto; }
            .header-logo { position: static; transform: none; margin-bottom: 10px; }
            .nav-group { position: static; transform: none; margin-top: 10px; justify-content: center; width: 100%; }
            .tag-filter-bar { justify-content: center; }
        }

        /* --- ESTRUTURA KANBAN --- */
        .kanban-container { 
            display: flex; gap: 15px; overflow-x: auto; min-height: 500px; 
            max-width: 1400px; margin-left: auto; margin-right: auto; align-items: flex-start;
        }
        .kanban-col { 
            flex: 1; min-width: 300px; background: #ebecf0; border-radius: 8px; padding: 10px; 
            display: flex; flex-direction: column; height: 100%;
        }
        .kanban-col-title { 
            font-weight: 900; text-transform: uppercase; margin-bottom: 12px; color: #42526e; 
            font-size: 1.1em; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid rgba(0,0,0,0.1); padding-bottom: 5px;
        }
        .kanban-cards-area { display: flex; flex-direction: column; gap: 10px; min-height: 50px; }

        /* --- CARD --- */
        .card { 
            background: var(--card-bg); width: 100%; border-radius: var(--border-radius); 
            box-shadow: 0 1px 3px rgba(0,0,0,0.15); padding: 5px; border: 2px solid transparent;
            position: relative; transition: transform 0.2s; box-sizing: border-box;
            display: flex; flex-direction: column; gap: 2px;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
        .card.deleted-card { opacity: 0.6; filter: grayscale(1); border: 2px dashed #999 !important; }

        .card-header-row { display: flex; justify-content: space-between; align-items: center; gap: 5px; margin-bottom: 0px; }
        .card-client { font-size: 1.15em; font-weight: 900; color: #000; text-transform: uppercase; line-height: 1.1; flex: 1; word-break: break-word; }
        
        .status-select-card { 
            width: auto; height: 20px; font-size: 0.65em; font-weight: 800; border-radius: 4px; 
            text-transform: uppercase; border: 1px solid #ccc; cursor: pointer; padding: 0 2px; text-align: center;
        }
        .card-sub-header { font-size: 0.85em; color: #666; font-style: italic; margin-top: -2px; margin-bottom: 2px; display: flex; align-items: center; gap: 6px; }
        .card-info-block { display: flex; justify-content: flex-start; align-items: center; gap: 5px; font-size: 0.8em; background: #f9f9f9; padding: 2px; border-radius: 4px;}
        .machine-text { color: #005f87; font-weight: 800; text-transform: uppercase; }
        .sn-text { background: #e9ecef; padding: 0 4px; border-radius: 2px; font-weight: 600; color: #444; white-space: nowrap; }
        .badges-container { display: flex; flex-wrap: wrap; gap: 2px; }
        .mini-badge { font-size: 0.65em; padding: 1px 4px; border-radius: 3px; font-weight: 700; text-transform: uppercase; color: white; background: #28a745; }
        .dates-row { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
        .date-group label { font-size: 0.7em; color: #777; margin-bottom: 0px; }
        .date-input-card { height: 18px; font-size: 0.75em; padding: 0 2px; border: 1px solid #ddd;}
        .tech-section { display: flex; gap: 4px; align-items: center; margin-top: 1px;}
        .tech-select-card { height: 22px; font-size: 0.75em; padding: 0 2px; font-weight: 600; color: #333; flex: 1; }
        .btn-wa-tech { background: #25d366; color: white; border: none; border-radius: 4px; width: 22px; height: 22px; cursor: pointer; font-size: 1.1em; display: flex; align-items: center; justify-content: center; }
        .desc-area-card { height: 28px; font-size: 0.85em; padding: 2px; background: #fafafa; border: 1px solid #eee; margin-top: 1px;}
        
        .comments-section { border-top: 1px solid #eee; padding-top: 2px; margin-top: 2px; }
        .comment-input-row { display: flex; gap: 3px; align-items: center; margin-bottom: 3px; }
        .comment-input-text { padding: 1px 4px; height: 22px; font-size: 0.75em; border: 1px solid #ddd; border-radius: 3px; flex: 1; }
        .comment-btn-save { width: 24px; height: 22px; font-size: 1em; cursor: pointer; border: 1px solid #28a745; background: #28a745; color: white; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
        .comment-list { list-style: none; padding: 0; margin: 0; font-size: 0.75em; max-height: 80px; overflow-y: auto; }
        .comment-item { background: #f1f1f1; border: 1px solid #eee; padding: 2px 4px; margin-bottom: 2px; border-radius: 3px; display: flex; flex-direction: column; }
        .comment-header { display: flex; justify-content: space-between; border-bottom: 1px solid #e0e0e0; margin-bottom: 1px; padding-bottom: 1px; font-size: 0.9em; }
        .comment-text { color: #444; word-break: break-word; flex: 1;}
        .comment-action-btn { background: none; border: none; cursor: pointer; font-size: 1em; padding: 0; color: #555; }

        .card-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 2px; }
        .last-mod { font-size: 0.65em; color: #888; font-style: italic; }
        
        /* CORRE√á√ÉO CR√çTICA: Z-INDEX ALTO PARA CLICABILIDADE */
        .card-actions-floating { 
            position: absolute; 
            top: -8px; 
            right: -5px; 
            display: flex; 
            gap: 2px; 
            background: white; 
            border-radius: 10px; 
            border: 1px solid #ddd; 
            padding: 2px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 99; /* Garante que fique acima de tudo */
        }
        .action-btn { background: none; border: none; font-size: 1.1em; cursor: pointer; padding: 0 4px; }
        .btn-edit { color: #0056b3; } 
        .btn-trash { color: #ccc; } .btn-trash:hover { color: orange; transform: scale(1.1); }
        .btn-restore { color: #28a745; } .btn-restore:hover { color: #1e7e34; transform: scale(1.1); } 
        .btn-delete-forever { color: #dc3545; } .btn-delete-forever:hover { color: #a71d2a; transform: scale(1.1); }
        
        #status-indicator { text-align: center; font-weight: bold; color: #666; font-size: 0.8em; margin-bottom: 5px; }
        #toast { visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 10px; position: fixed; z-index: 1000; left: 50%; bottom: 20px; transform: translateX(-50%); font-size: 12px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        
        /* MODAL GERAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 15px; border-radius: 6px; width: 90%; max-width: 450px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 13px;}
        .modal-title { font-weight: bold; font-size: 1.1em; margin-bottom: 10px; color: var(--primary); text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .modal-form-group { margin-bottom: 8px; }
        .modal-form-group label { margin-bottom: 3px; color: #555; font-size: 0.9em; display:block; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; }
        .btn-modal-cancel { background: #ccc; border: none; padding: 8px 15px; border-radius: 3px; cursor: pointer; font-weight: bold; font-size: 0.95em; }
        .btn-modal-save { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 3px; cursor: pointer; font-weight: bold; font-size: 0.95em; }

        /* --- MODAL ESTAT√çSTICAS --- */
        #statsModal .modal-box { max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto; }
        .stats-summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stats-card { background: #f8f9fa; border-radius: 8px; padding: 15px; text-align: center; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stats-card h3 { margin: 0; font-size: 2.5em; font-weight: 900; color: #333; }
        .stats-card span { font-size: 0.9em; color: #666; font-weight: bold; text-transform: uppercase; }
        
        .stats-details-container { display: flex; flex-wrap: wrap; gap: 20px; }
        .stats-col { flex: 1; min-width: 300px; }
        .stats-col h4 { border-bottom: 2px solid #ddd; padding-bottom: 5px; color: var(--primary); margin-bottom: 10px; }
        
        .stats-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .stats-table th, .stats-table td { padding: 6px; text-align: left; border-bottom: 1px solid #eee; }
        .stats-table th { background: #f1f1f1; font-weight: bold; }
        .stats-table tr:hover { background: #f9f9f9; }
    </style>
</head>
<body>

    <div class="header-container">
        <img src="logo.png" onerror="this.style.display='none'" alt="Logo" class="header-logo">
        <h1><strong>GEST√ÉO DE AGENDAMENTOS</strong></h1>
        <div class="nav-group">
            <button class="nav-btn stats-btn" onclick="window.openStatsModal()">üìä Estat√≠sticas</button>
            <a href="painel.html" class="nav-btn">‚öôÔ∏è Painel T√©cnico</a>
        </div>
    </div>

    <div id="status-indicator">Conectando... ‚è≥</div>

    <div class="control-panel">
        <div class="header-grid">
            <div>
                <label>Equipamentos</label>
                <select id="machineType" onchange="window.updateSnFields()">
                    <option value="" disabled selected>Selecione o equipamento</option>
                    <optgroup label="FABRICANTE: SIEMENS">
                        <option disabled class="sub-header">--- >-LINHA ATELLICA-< ---</option>
                        <option value="ATELLICA SC">ATELLICA SC</option>
                        <option value="ATELLICA SCI">ATELLICA SCI</option>
                        <option value="ATELLICA SI">ATELLICA SI</option>
                        <option value="ATELLICA SCCI">ATELLICA SCCI</option>
                        <option value="ATELLICA SCII">ATELLICA SCII</option>
                        <option disabled class="sub-header">--- BIOQU√çMICA ---</option>
                        <option value="ADVIA 1800">ADVIA 1800</option>
                        <option value="ADVIA 2120">ADVIA 2120</option>
                        <option value="BN PROSPEC">BN PROSPEC</option>
                        <option value="DIMENSION EXL / RXL">DIMENSION EXL / RXL</option>
                        <option disabled class="sub-header">--- HEMATOLOGIA ---</option>
                        <option value="ADVIA 360">ADVIA 360</option>
                        <option value="ADVIA 560">ADVIA 560</option>
                        <option value="HEMATEK 3000">HEMATEK 3000</option>
                        <option disabled class="sub-header">--- IMUNOLOGIA ---</option>
                        <option value="CENTAUR CP">CENTAUR CP</option>
                        <option value="CENTAUR XP">CENTAUR XP</option>
                        <option value="IMMULITE 2000 XPI">IMMULITE 2000 XPI</option>
                        <option disabled class="sub-header">--- COAGULA√á√ÉO ---</option>
                        <option value="CA 660">CA 660</option>
                        <option value="CS 2500">CS 2500</option>
                        <option value="FIBRINTIMER II">FIBRINTIMER II</option>
                        <option disabled class="sub-header">--- GASOMETRIA ---</option>
                        <option value="EPOC NXS / EPOC MC">EPOC NXS / EPOC MC</option>
                        <option value="RAPIDLAB 348 / 348EX">RAPIDLAB 348 / 348EX</option>
                        <option value="RP 500 / RP 500e">RP 500 / RP 500e</option>
                        <option disabled class="sub-header">--- URIAN√ÅLISE ---</option>
                        <option value="CLINITEK ADVANTUS">CLINITEK ADVANTUS</option>
                        <option value="CLINITEK STATUS">CLINITEK STATUS</option>
                    </optgroup>
                    <optgroup label="FABRICANTE: LABTEST">
                        <option disabled class="sub-header">--- BIOQU√çMICA ---</option>
                        <option value="AUDMAX 360 C/ ISE">AUDMAX 360 C/ ISE</option>
                        <option value="AUDMAX EVOLUTION">AUDMAX EVOLUTION</option>
                        <option value="CS 240">CS 240</option>
                        <option value="CS 400">CS 400</option>
                        <option value="CS 800">CS 800</option>
                        <option value="LABMAX 100">LABMAX 100</option>
                        <option value="LABMAX 240 / PREMIUM">LABMAX 240 / PREMIUM</option>
                        <option value="LABMAX 450I">LABMAX 450I</option>
                        <option value="LABMAX 560">LABMAX 560</option>
                        <option value="LABMAX PLENNO">LABMAX PLENNO</option>
                        <option disabled class="sub-header">--- HEMATOLOGIA ---</option>
                        <option value="SDH 20">SDH 20</option>
                        <option value="SDH 5">SDH 5</option>
                    </optgroup>
                    <optgroup label="FABRICANTE: NIHON">
                        <option disabled class="sub-header">--- HEMATOLOGIA ---</option>
                        <option value="MEK 6500">MEK 6500</option>
                        <option value="MEK 6550">MEK 6550</option>
                        <option value="MEK 7300">MEK 7300</option>
                        <option value="MEK 9100">MEK 9100</option>
                        <option value="MEK-9200K">MEK-9200K</option>
                    </optgroup>
                    <optgroup label="FABRICANTE: MHLAB">
                        <option disabled class="sub-header">--- BIOQU√çMICA ---</option>
                        <option value="PKL 125">PKL 125</option>
                        <option value="CA 200">CA 200</option>
                        <option disabled class="sub-header">--- HEMATOLOGIA ---</option>
                        <option value="BH-5100">BH-5100</option>
                        <option value="BH-5390">BH-5390</option>
                        <option disabled class="sub-header">--- URIAN√ÅLISE ---</option>
                        <option value="URIT US-500">URIT US-500</option>
                    </optgroup>
                    <optgroup label="FABRICANTE: IN VITRO">
                        <option disabled class="sub-header">--- HEMATOLOGIA ---</option>
                        <option value="HUMANCOUNT 30 TS">HUMANCOUNT 30 TS</option>
                        <option disabled class="sub-header">--- √çONS ---</option>
                        <option value="HUMALYTE PLUS 3">HUMALYTE PLUS 3</option>
                        <option value="HUMALYTE PLUS 5">HUMALYTE PLUS 5</option>
                    </optgroup>
                    <optgroup label="FABRICANTE: WAMA">
                        <option disabled class="sub-header">--- COAGULA√á√ÉO ---</option>
                        <option value="COAGMASTER 2.0 / 4.0">COAGMASTER 2.0 / 4.0</option>
                        <option value="COAGMASTER BR">COAGMASTER BR</option>
                        <option disabled class="sub-header">--- URIAN√ÅLISE ---</option>
                        <option value="URIVISION 300">URIVISION 300</option>
                    </optgroup>
                    <optgroup label="FABRICANTE: ECO">
                        <option disabled class="sub-header">--- IMUNOLOGIA ---</option>
                        <option value="F100">F100</option>
                        <option value="F200">F200</option>
                    </optgroup>
                    <optgroup label="FABRICANTE: VIDA BIO">
                        <option disabled class="sub-header">--- URIAN√ÅLISE ---</option>
                        <option value="URIVIDA 500">URIVIDA 500</option>
                        <option value="URIVIDA 1000">URIVIDA 1000</option>
                    </optgroup>
                </select>
            </div>
            <div><label>N¬∫ de S√©rie</label><input type="text" id="snField" placeholder="S/N..."></div>
            <div><label>N¬∫ OS</label><input type="text" id="osField" placeholder="OS..."></div>
            <div><label>Nome do Cliente</label><input type="text" id="clientName" placeholder="Ex: Laborat√≥rio X"></div>
            <div><label>Cidade</label><input type="text" id="clientCity"></div>
            
            <div>
                <label>Tipo de Atendimento</label>
                <select id="serviceType">
                    <option value="PREVENTIVA">Preventiva</option>
                    <option value="CORRETIVA">Corretiva</option>
                    <option value="INSTALA√á√ÉO">Instala√ß√£o</option>
                    <option value="MOVIMENTA√á√ÉO">Movimenta√ß√£o</option>
                    <option value="REMO√á√ÉO">Remo√ß√£o</option>
                </select>
            </div>
        </div>

        <div class="dates-grid">
            <div>
                <label>Regi√£o de Atendimento</label>
                <select id="serviceRegion">
                    <option value="" disabled selected>Selecione...</option>
                    <optgroup label="S√ÉO PAULO">
                        <option value="S√ÉO PAULO CAPITAL">S√ÉO PAULO CAPITAL</option>
                        <option value="LITORAL">LITORAL</option>
                        <option value="ABC PAULISTA">ABC PAULISTA</option>
                        <option value="VALE DO PARA√çBA">VALE DO PARA√çBA</option>
                        <option value="VALE DO RIBEIRA">VALE DO RIBEIRA</option>
                        <option value="CAMPINAS">CAMPINAS</option>
                    </optgroup>
                    <optgroup label="OUTRAS REGI√ïES">
                        <option value="RIBEIR√ÉO PRETO">RIBEIR√ÉO PRETO</option>
                        <option value="MINAS GERAIS">MINAS GERAIS</option>
                        <option value="GOI√ÅS">GOI√ÅS</option>
                        <option value="MATO GROSSO">MATO GROSSO</option>
                        <option value="RIO GRANDE DO SUL">RIO GRANDE DO SUL</option>
                    </optgroup>
                </select>
            </div>
            <div><label>Data Solicita√ß√£o:</label><input type="date" id="reqDate"></div>
            <div><label>Data Agendamento:</label><input type="date" id="schedDate"></div>
            <div style="grid-column: span 2;"><label>Descri√ß√£o da Solicita√ß√£o:</label><input type="text" id="descField" placeholder="Detalhes do servi√ßo..."></div>
        </div>

        <div class="btn-group">
            <button class="add-btn" onclick="window.addNewCard()">Adicionar Agendamento</button>
        </div>
    </div>

    <div class="filter-bar">
        <span style="font-weight:bold;">üîé Filtrar:</span>
        <input type="text" class="filter-input" id="searchBar" placeholder="Busque por cliente, t√©cnico ou S/N..." oninput="window.filterCards()">
        <select class="filter-select" id="filterStatus" onchange="window.filterCards()" style="max-width:200px;">
            <option value="TODOS">Todos</option>
            <option value="N√ÉO INICIADO">N√£o Iniciado</option>
            <option value="EM ANDAMENTO">Em Andamento</option>
            <option value="CONCLU√çDO">Conclu√≠dos</option>
            <option value="ARQUIVADO">Arquivados</option>
            <option value="LIXEIRA" style="color:red; font-weight:bold;">üóëÔ∏è Lixeira</option>
        </select>
        <span class="filter-count" id="cardCount">0 registros</span>
    </div>

    <div class="tag-filter-bar">
        <span style="font-weight:bold; font-size:11px; margin-right:5px; align-self:center;">Regi√µes:</span>
        <button class="tag-btn active" id="tag-all" onclick="window.filterByRegion('TODAS')">TODAS</button>
        <button class="tag-btn" onclick="window.filterByRegion('S√ÉO PAULO CAPITAL')">S√ÉO PAULO CAPITAL</button>
        <button class="tag-btn" onclick="window.filterByRegion('LITORAL')">LITORAL</button>
        <button class="tag-btn" onclick="window.filterByRegion('ABC PAULISTA')">ABC PAULISTA</button>
        <button class="tag-btn" onclick="window.filterByRegion('VALE DO PARA√çBA')">VALE DO PARA√çBA</button>
        <button class="tag-btn" onclick="window.filterByRegion('VALE DO RIBEIRA')">VALE DO RIBEIRA</button>
        <button class="tag-btn" onclick="window.filterByRegion('CAMPINAS')">CAMPINAS</button>
        <button class="tag-btn" onclick="window.filterByRegion('RIBEIR√ÉO PRETO')">RIBEIR√ÉO PRETO</button>
        <button class="tag-btn" onclick="window.filterByRegion('MINAS GERAIS')">MINAS GERAIS</button>
        <button class="tag-btn" onclick="window.filterByRegion('GOI√ÅS')">GOI√ÅS</button>
        <button class="tag-btn" onclick="window.filterByRegion('MATO GROSSO')">MATO GROSSO</button>
        <button class="tag-btn" onclick="window.filterByRegion('RIO GRANDE DO SUL')">RIO GRANDE DO SUL</button>
    </div>

    <div class="kanban-container">
        <div class="kanban-col" style="border-top: 4px solid #ffc107;">
            <div class="kanban-col-title">
                <span>N√ÉO INICIADO</span>
                <span id="count-nao-iniciado" style="font-size:0.8em; background:#ddd; padding:2px 6px; border-radius:10px;">0</span>
            </div>
            <div class="kanban-cards-area" id="col-nao-iniciado"></div>
        </div>

        <div class="kanban-col" style="border-top: 4px solid #0dcaf0;">
            <div class="kanban-col-title">
                <span>EM ANDAMENTO</span>
                <span id="count-em-andamento" style="font-size:0.8em; background:#ddd; padding:2px 6px; border-radius:10px;">0</span>
            </div>
            <div class="kanban-cards-area" id="col-em-andamento"></div>
        </div>

        <div class="kanban-col" style="border-top: 4px solid #198754;">
            <div class="kanban-col-title">
                <span>CONCLU√çDO</span>
                <span id="count-concluido" style="font-size:0.8em; background:#ddd; padding:2px 6px; border-radius:10px;">0</span>
            </div>
            <div class="kanban-cards-area" id="col-concluido"></div>
        </div>
    </div>

    <div id="toast">üîî Salvo com sucesso!</div>

    <div class="modal-overlay" id="editModal">
        <div class="modal-box">
            <div class="modal-title">Editar Agendamento</div>
            <div class="modal-form-group"><label>Cliente</label><input type="text" id="modClient"></div>
            <div class="modal-form-group"><label>Cidade</label><input type="text" id="modCity"></div>
            <div class="modal-form-group"><label>N¬∫ OS</label><input type="text" id="modOs"></div>
            <div class="modal-form-group"><label>Equipamento</label><input type="text" id="modMachine"></div>
            <div class="modal-form-group"><label>S/N</label><input type="text" id="modSn"></div>
            <div class="modal-form-group"><label>Regi√£o</label><input type="text" id="modRegion"></div>
            <div class="modal-form-group">
                <label>Tipo de Atendimento</label>
                <select id="modServiceType">
                    <option value="PREVENTIVA">Preventiva</option>
                    <option value="CORRETIVA">Corretiva</option>
                    <option value="INSTALA√á√ÉO">Instala√ß√£o</option>
                    <option value="MOVIMENTA√á√ÉO">Movimenta√ß√£o</option>
                    <option value="REMO√á√ÉO">Remo√ß√£o</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn-modal-cancel" onclick="window.closeEditModal()">Cancelar</button>
                <button class="btn-modal-save" onclick="window.saveEditModal()">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="statsModal">
        <div class="modal-box">
            <div class="modal-title" style="display:flex; justify-content:space-between; align-items:center;">
                ESTAT√çSTICAS GERAIS
                <select id="statsMonthFilter" onchange="window.updateStats()" style="width:auto; max-width:200px; font-size:0.8em;">
                    <option value="TODOS">TODOS OS PER√çODOS</option>
                </select>
            </div>
            
            <div class="stats-summary-grid">
                <div class="stats-card" style="border-left: 5px solid #ffc107;">
                    <h3 id="stat-pending">0</h3>
                    <span>N√£o Iniciado</span>
                </div>
                <div class="stats-card" style="border-left: 5px solid #0dcaf0;">
                    <h3 id="stat-progress">0</h3>
                    <span>Em Andamento</span>
                </div>
                <div class="stats-card" style="border-left: 5px solid #198754;">
                    <h3 id="stat-done">0</h3>
                    <span>Conclu√≠do</span>
                </div>
                <div class="stats-card" style="border-left: 5px solid #6c757d;">
                    <h3 id="stat-archived">0</h3>
                    <span>Arquivado</span>
                </div>
            </div>

            <div class="stats-details-container">
                <div class="stats-col">
                    <h4>Por T√©cnico</h4>
                    <table class="stats-table">
                        <thead><tr><th>T√©cnico</th><th>Qtd.</th></tr></thead>
                        <tbody id="table-techs"></tbody>
                    </table>
                </div>
                <div class="stats-col">
                    <h4>Por Regi√£o</h4>
                    <table class="stats-table">
                        <thead><tr><th>Regi√£o</th><th>Qtd.</th></tr></thead>
                        <tbody id="table-regions"></tbody>
                    </table>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn-modal-cancel" onclick="document.getElementById('statsModal').style.display='none'">Fechar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA3Xg_0LLGDVeRv5jVGnSFESc8I4Z1fsA8",
            authDomain: "projeto-atellica.firebaseapp.com",
            projectId: "projeto-atellica",
            storageBucket: "projeto-atellica.firebasestorage.app",
            messagingSenderId: "422526536640",
            appId: "1:422526536640:web:0afcb40f3e79ccf93e9625"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const boardRef = doc(db, "scrum_board", "agendamentos_db");

        let currentCardsData = [];
        let currentEditingId = null;
        let editingCommentId = null;
        let currentRegionFilter = 'TODAS';

        const techniciansList = {
            "T√âCNICO SP": ["Daniel Ourique", "Daniel Serrano", "Eduardo Rafael", "Fabio Mazine", "Guilherme Yoshida", "Matheus Pereira", "Oseias Barbosa", "Rafael Rodrigues", "Robson Miranda", "Rubens Emerson", "Vanleno C√¢mara", "Wesley Monteiro"].sort(),
            "T√âCNICO RP": ["Alexandre Chiang", "Fred Shigeyo", "M√°rio Luiz", "Rafael Aihara", "Rainan Hanzi"],
            "T√âCNICO RS": ["Adilson Domingues", "Nilton Cesar Alves"],
            "T√âCNICO MINAS GERAIS": ["Fabricio Vallin"],
            "T√âCNICO GOI√ÅS": ["Luiz Bonazza"],
            "T√âCNICO OUTROS": ["OUTROS"]
        };

        const techPhones = {
            "Daniel Ourique": "5511999192506", 
            "Daniel Serrano": "5511947243198",
            "Eduardo Rafael": "5511971267829",
            "Guilherme Yoshida": "5511947596822",
            "Matheus Pereira": "5511922280926",
            "Rafael Rodrigues": "5511947249934",
            "Robson Miranda": "5511932735459",
            "Rubens Emerson": "5511911533964",
            "Alexandre Chiang": "5511911534018",
            "Fred Shigeyo": "5511944880158",
            "M√°rio Luiz": "5511942368827",
            "Rafael Aihara": "5516997725520",
            "Rainan Hanzi": "5511930966411",
            "Adilson Domingues": "5511941978167",
            "Nilton Cesar Alves": "5516997355896",
            "Fabricio Vallin": "553192750275",
            "Luiz Bonazza": "556793227629",
            "Wesley Monteiro": "5511941227458",
            "Vanleno C√¢mara": "5511995488512",
            "Oseias Barbosa": "5511919120197",
            "Fabio Mazine": "5511957760321"
        };

        window.updateSnFields = function() { }

        function getTechSelectHTML(selectedTech) {
            let html = '<option value="">Selecione o T√©cnico...</option>';
            for (const [region, techs] of Object.entries(techniciansList)) {
                html += `<optgroup label="${region}">`;
                techs.sort().forEach(tech => {
                    const isSel = selectedTech === tech ? 'selected' : '';
                    html += `<option value="${tech}" ${isSel}>${tech}</option>`;
                });
                html += `</optgroup>`;
            }
            return html;
        }

        const escapeAttr = (str) => String(str).replace(/'/g, "\\'").replace(/"/g, "&quot;");

        function playNotificationSound() { 
            try { 
                const ctx = new (window.AudioContext || window.webkitAudioContext)(); 
                const osc = ctx.createOscillator(); 
                const gain = ctx.createGain(); 
                osc.connect(gain); 
                gain.connect(ctx.destination); 
                osc.type = 'sine'; 
                osc.frequency.setValueAtTime(600, ctx.currentTime); 
                osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1); 
                gain.gain.setValueAtTime(0.1, ctx.currentTime); 
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5); 
                osc.start(); 
                osc.stop(ctx.currentTime + 0.5); 
            } catch (e) { } 
        }

        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.className = "show"; setTimeout(() => t.className = "", 3000); }

        function normalizeStatus(card) {
            if (card.manualStatus === 'PENDENTE') return 'N√ÉO INICIADO';
            if (card.manualStatus === 'AGENDADO') return 'EM ANDAMENTO';
            return card.manualStatus || 'N√ÉO INICIADO';
        }

        function isLate(card) {
            if (card.manualStatus === 'CONCLU√çDO' || card.manualStatus === 'ARQUIVADO') return false;
            const today = new Date().toISOString().split('T')[0];
            if (card.dateSched && card.dateSched < today) return true;
            return false;
        }

        window.addNewCard = function() {
            const machine = document.getElementById('machineType').value;
            const client = document.getElementById('clientName').value;
            
            if (!machine || !client) { alert("Preencha Equipamento e Cliente!"); return; }

            const newCard = {
                id: 'agenda-' + Date.now(),
                machine: machine,
                sn: document.getElementById('snField').value,
                osNum: document.getElementById('osField').value, 
                client: client,
                city: document.getElementById('clientCity').value,
                serviceType: document.getElementById('serviceType').value,
                region: document.getElementById('serviceRegion').value,
                dateReq: document.getElementById('reqDate').value,
                dateSched: document.getElementById('schedDate').value,
                desc: document.getElementById('descField').value,
                tech: "", 
                manualStatus: "N√ÉO INICIADO",
                lastUpdated: new Date().toLocaleString('pt-BR'),
                isDeleted: false,
                comments: [] 
            };

            currentCardsData.push(newCard);
            
            document.getElementById('machineType').selectedIndex = 0;
            document.getElementById('snField').value = '';
            document.getElementById('osField').value = ''; 
            document.getElementById('clientName').value = '';
            document.getElementById('clientCity').value = '';
            document.getElementById('serviceType').selectedIndex = 0;
            document.getElementById('serviceRegion').selectedIndex = 0;
            document.getElementById('reqDate').value = '';
            document.getElementById('schedDate').value = '';
            document.getElementById('descField').value = '';
            
            saveToCloud();
        }

        window.updateCard = function(id, field, value) {
            const idx = currentCardsData.findIndex(c => c.id === id);
            if (idx > -1) {
                currentCardsData[idx][field] = value;
                currentCardsData[idx].lastUpdated = new Date().toLocaleString('pt-BR');
                if(field === 'dateSched') renderBoard(currentCardsData);
                else saveToCloud(false);
            }
        }

        window.updateStatus = function(id, newStatus) {
            const idx = currentCardsData.findIndex(c => c.id === id);
            if (idx > -1) {
                currentCardsData[idx].manualStatus = newStatus;
                currentCardsData[idx].lastUpdated = new Date().toLocaleString('pt-BR');
                renderBoard(currentCardsData);
                window.filterCards(); 
                saveToCloud(false);
            }
        }

        window.sendTechMsg = function(id) {
            const card = currentCardsData.find(c => c.id === id);
            if (!card || !card.tech) { alert("Selecione um t√©cnico primeiro."); return; }
            
            const phone = techPhones[card.tech];
            if (!phone) { alert(`N√∫mero do t√©cnico ${card.tech} n√£o cadastrado no sistema.`); return; }

            const msg = `Ol√° *${card.tech}*, um novo agendamento esta atribu√≠do em seu nome:\n\n*Cliente:* ${card.client}\n*Cidade:* ${card.city}\n*Equipamento:* ${card.machine}\n*S/N:* ${card.sn}\n*Data:* ${card.dateSched ? card.dateSched.split('-').reverse().join('/') : 'A definir'}\n*Servi√ßo:* ${card.serviceType}\n\n*Descri√ß√£o:* ${card.desc}\n*OS:* ${card.osNum || 'N/A'}`;
            
            const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        }

        window.addAgendaComment = function(cardId) {
            const textIn = document.getElementById(`comm-in-${cardId}`);
            if(!textIn) return;
            const text = textIn.value.trim();
            if(!text) return;
            const idx = currentCardsData.findIndex(c => c.id === cardId);
            if(idx > -1) {
                if(editingCommentId) {
                    const cIdx = currentCardsData[idx].comments.findIndex(c => c.id === editingCommentId);
                    if(cIdx > -1) {
                        currentCardsData[idx].comments[cIdx].text = text;
                        currentCardsData[idx].comments[cIdx].time = new Date().toLocaleString('pt-BR') + ' (Editado)';
                    }
                    editingCommentId = null;
                } else {
                    if(!currentCardsData[idx].comments) currentCardsData[idx].comments = [];
                    currentCardsData[idx].comments.push({ id: 'ac-' + Date.now(), text: text, time: new Date().toLocaleString('pt-BR') });
                }
                currentCardsData[idx].lastUpdated = new Date().toLocaleString('pt-BR');
                textIn.value = '';
                renderBoard(currentCardsData); 
                saveToCloud(false);
            }
        }

        window.editAgendaComment = function(cardId, commentId) {
            const card = currentCardsData.find(c => c.id === cardId);
            const comment = card.comments.find(c => c.id === commentId);
            if(comment) {
                const input = document.getElementById(`comm-in-${cardId}`);
                if(input) { input.value = comment.text; editingCommentId = commentId; input.focus(); }
            }
        }

        window.deleteAgendaComment = function(cardId, commentId) {
            const idx = currentCardsData.findIndex(c => c.id === cardId);
            if(idx > -1 && confirm("Excluir coment√°rio?")) {
                currentCardsData[idx].comments = currentCardsData[idx].comments.filter(c => c.id !== commentId);
                currentCardsData[idx].lastUpdated = new Date().toLocaleString('pt-BR');
                renderBoard(currentCardsData);
                saveToCloud(false);
            }
        }

        window.openEditModal = function(id) {
            const card = currentCardsData.find(c => c.id === id); if(!card) return;
            currentEditingId = id;
            document.getElementById('modClient').value = card.client;
            document.getElementById('modCity').value = card.city;
            document.getElementById('modOs').value = card.osNum || '';
            document.getElementById('modMachine').value = card.machine;
            document.getElementById('modSn').value = card.sn;
            document.getElementById('modRegion').value = card.region;
            document.getElementById('modServiceType').value = card.serviceType; 
            document.getElementById('editModal').style.display = 'flex';
        }
        window.closeEditModal = function() { document.getElementById('editModal').style.display = 'none'; currentEditingId = null; }
        window.saveEditModal = function() {
            if(!currentEditingId) return;
            const idx = currentCardsData.findIndex(c => c.id === currentEditingId);
            if(idx > -1) {
                currentCardsData[idx].client = document.getElementById('modClient').value;
                currentCardsData[idx].city = document.getElementById('modCity').value;
                currentCardsData[idx].osNum = document.getElementById('modOs').value; 
                currentCardsData[idx].machine = document.getElementById('modMachine').value;
                currentCardsData[idx].sn = document.getElementById('modSn').value;
                currentCardsData[idx].region = document.getElementById('modRegion').value;
                currentCardsData[idx].serviceType = document.getElementById('modServiceType').value; 
                currentCardsData[idx].lastUpdated = new Date().toLocaleString('pt-BR');
                renderBoard(currentCardsData);
                saveToCloud();
                closeEditModal();
            }
        }

        // --- FUN√á√ïES DE EXCLUS√ÉO CORRIGIDAS ---
        window.deleteCard = function(id) {
            const idx = currentCardsData.findIndex(c => c.id === id);
            if (idx > -1 && confirm("Mover para lixeira?")) {
                currentCardsData[idx].isDeleted = true;
                saveToCloud();
            }
        }

        window.restoreCard = function(id) {
            const idx = currentCardsData.findIndex(c => c.id === id);
            if (idx > -1) {
                currentCardsData[idx].isDeleted = false;
                saveToCloud();
            }
        }

        window.deleteForever = function(id) {
            const idx = currentCardsData.findIndex(c => c.id === id);
            if (idx > -1 && confirm("ATEN√á√ÉO: Isso excluir√° o agendamento permanentemente. Continuar?")) {
                currentCardsData.splice(idx, 1);
                saveToCloud();
            }
        }

        window.saveToCloud = async function(refresh = true) {
            document.getElementById('status-indicator').innerText = "Salvando... üü†";
            playNotificationSound(); 
            try {
                await updateDoc(boardRef, { cards: currentCardsData });
                document.getElementById('status-indicator').innerText = "Online üü¢";
                if(refresh) { renderBoard(currentCardsData); window.filterCards(); }
            } catch (e) { console.error(e); }
        }

        window.filterByRegion = function(region) {
            currentRegionFilter = region;
            document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('active'));
            const allBtns = document.querySelectorAll('.tag-btn');
            for(let btn of allBtns) {
                if(btn.innerText.toUpperCase() === (region === 'TODAS' ? 'TODAS' : region)) {
                    btn.classList.add('active');
                }
            }
            if(region === 'TODAS') document.getElementById('tag-all').classList.add('active');
            window.filterCards();
        }

        window.filterCards = function() {
            const term = document.getElementById('searchBar').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            
            const filtered = currentCardsData.filter(c => {
                const matchesText = (c.client + c.city + c.machine + c.tech + c.sn + (c.osNum || '')).toLowerCase().includes(term);
                const status = normalizeStatus(c);
                const matchesRegion = (currentRegionFilter === 'TODAS') || (c.region === currentRegionFilter);

                if (statusFilter === 'LIXEIRA') return c.isDeleted && matchesText && matchesRegion;
                if (c.isDeleted) return false; 

                if (statusFilter === 'TODOS') return matchesText && matchesRegion && status !== 'ARQUIVADO';
                if (statusFilter === 'ARQUIVADO') return status === 'ARQUIVADO' && matchesText && matchesRegion;
                
                return status === statusFilter && matchesText && matchesRegion;
            });

            renderBoard(filtered);
            document.getElementById('cardCount').innerText = filtered.length + " registros";
        }

        window.openStatsModal = function() {
            populateMonthFilter();
            window.updateStats();
            document.getElementById('statsModal').style.display = 'flex';
        }

        function populateMonthFilter() {
            const filter = document.getElementById('statsMonthFilter');
            filter.innerHTML = '<option value="TODOS">TODOS OS PER√çODOS</option>';
            const uniqueMonths = new Set();
            currentCardsData.forEach(c => { if(c.dateSched) uniqueMonths.add(c.dateSched.substring(0, 7)); });
            const sortedMonths = Array.from(uniqueMonths).sort().reverse();
            sortedMonths.forEach(m => {
                const [year, month] = m.split('-');
                const monthName = new Date(year, month - 1).toLocaleString('pt-BR', { month: 'long' });
                const opt = document.createElement('option');
                opt.value = m;
                opt.innerText = `${monthName}/${year}`.toUpperCase();
                filter.appendChild(opt);
            });
        }

        window.updateStats = function() {
            const monthFilter = document.getElementById('statsMonthFilter').value;
            let countPending = 0; let countProgress = 0; let countDone = 0; let countArchived = 0;
            const techCounts = {}; const regionCounts = {};

            currentCardsData.forEach(c => {
                if(monthFilter !== 'TODOS') { if(!c.dateSched || !c.dateSched.startsWith(monthFilter)) return; }
                const status = normalizeStatus(c);
                if(!c.isDeleted) {
                    if(status === 'N√ÉO INICIADO') countPending++;
                    if(status === 'EM ANDAMENTO') countProgress++;
                    if(status === 'CONCLU√çDO') countDone++;
                    if(status === 'ARQUIVADO') countArchived++;
                    if(c.tech) { techCounts[c.tech] = (techCounts[c.tech] || 0) + 1; } else { techCounts['SEM T√âCNICO'] = (techCounts['SEM T√âCNICO'] || 0) + 1; }
                    const reg = c.region || 'SEM REGI√ÉO'; regionCounts[reg] = (regionCounts[reg] || 0) + 1;
                }
            });

            document.getElementById('stat-pending').innerText = countPending;
            document.getElementById('stat-progress').innerText = countProgress;
            document.getElementById('stat-done').innerText = countDone;
            document.getElementById('stat-archived').innerText = countArchived;

            const tableTechs = document.getElementById('table-techs'); tableTechs.innerHTML = '';
            Object.entries(techCounts).sort((a,b) => b[1] - a[1]).forEach(([tech, qtd]) => { tableTechs.innerHTML += `<tr><td>${tech}</td><td>${qtd}</td></tr>`; });

            const tableRegions = document.getElementById('table-regions'); tableRegions.innerHTML = '';
            Object.entries(regionCounts).sort((a,b) => b[1] - a[1]).forEach(([reg, qtd]) => { tableRegions.innerHTML += `<tr><td>${reg}</td><td>${qtd}</td></tr>`; });
        }

        function renderBoard(cards) {
            const col1 = document.getElementById('col-nao-iniciado');
            const col2 = document.getElementById('col-em-andamento');
            const col3 = document.getElementById('col-concluido');
            
            col1.innerHTML = ''; col2.innerHTML = ''; col3.innerHTML = '';
            let count1 = 0, count2 = 0, count3 = 0;

            cards.sort((a, b) => {
                const dA = a.dateSched || '9999-99-99';
                const dB = b.dateSched || '9999-99-99';
                return dA.localeCompare(dB);
            });

            cards.forEach(c => {
                const status = normalizeStatus(c);
                const late = isLate(c);
                
                let targetContainer = null;
                if (status === 'N√ÉO INICIADO') { targetContainer = col1; count1++; }
                else if (status === 'EM ANDAMENTO') { targetContainer = col2; count2++; }
                else if (status === 'CONCLU√çDO') { targetContainer = col3; count3++; }
                
                const currentFilter = document.getElementById('filterStatus').value;
                if ((status === 'ARQUIVADO' || c.isDeleted) && targetContainer === null) {
                    if(currentFilter === 'ARQUIVADO' || currentFilter === 'LIXEIRA') targetContainer = col2; 
                }

                if (!targetContainer) return;

                const card = document.createElement('div');
                card.className = `card ${c.isDeleted ? 'deleted-card' : ''}`;
                card.style.border = late ? '4px solid #dc3545' : '2px solid transparent';

                let selectBg = '#e2e2e2'; let selectColor = '#333';
                if (status === 'EM ANDAMENTO') { selectBg = '#0dcaf0'; selectColor = '#000'; } 
                if (status === 'CONCLU√çDO') { selectBg = '#198754'; selectColor = '#fff'; } 
                if (status === 'ARQUIVADO') { selectBg = '#6c757d'; selectColor = '#fff'; }

                const commentsList = (c.comments || []).map(com => `
                    <li class="comment-item">
                        <div class="comment-header">
                            <span class="comment-time">${com.time}</span>
                            <div>
                                <button class="comment-action-btn" onclick="window.editAgendaComment('${c.id}', '${com.id}')">‚úé</button>
                                <button class="comment-action-btn" onclick="window.deleteAgendaComment('${c.id}', '${com.id}')">‚ùå</button>
                            </div>
                        </div>
                        <div class="comment-text">${com.text}</div>
                    </li>
                `).join('');

                let actionButtonsHtml = '';
                if (c.isDeleted) {
                    actionButtonsHtml = `
                        <button class="action-btn btn-restore" onclick="window.restoreCard('${c.id}')" title="Restaurar">‚ôªÔ∏è</button>
                        <button class="action-btn btn-delete-forever" onclick="window.deleteForever('${c.id}')" title="Excluir Definitivamente">üî•</button>
                    `;
                } else {
                    actionButtonsHtml = `
                        <button class="action-btn btn-edit" onclick="window.openEditModal('${c.id}')" title="Editar">‚úé</button>
                        <button class="action-btn btn-trash" onclick="window.deleteCard('${c.id}')" title="Excluir">√ó</button>
                    `;
                }

                card.innerHTML = `
                    <div class="card-actions-floating">
                        ${actionButtonsHtml}
                    </div>

                    <div class="card-header-row">
                        <div class="card-client">${c.client}</div>
                        <select class="status-select-card" onchange="window.updateStatus('${c.id}', this.value)" 
                                style="background-color: ${selectBg}; color: ${selectColor}; border-color: ${selectBg};">
                            <option value="N√ÉO INICIADO" ${status === 'N√ÉO INICIADO' ? 'selected' : ''}>N√ÉO INICIADO</option>
                            <option value="EM ANDAMENTO" ${status === 'EM ANDAMENTO' ? 'selected' : ''}>EM ANDAMENTO</option>
                            <option value="CONCLU√çDO" ${status === 'CONCLU√çDO' ? 'selected' : ''}>CONCLU√çDO</option>
                            <option value="ARQUIVADO" ${status === 'ARQUIVADO' ? 'selected' : ''}>ARQUIVAR</option>
                        </select>
                    </div>
                    
                    <div class="card-sub-header">
                        ${c.city || ''}
                    </div>

                    <div class="card-info-block">
                        <span class="machine-text">${c.machine}</span>
                        <span class="sn-text">S/N: ${c.sn || '---'}</span>
                    </div>

                    <div class="badges-container">
                        <span class="mini-badge bg-serv">${c.serviceType}</span>
                        <span class="mini-badge bg-reg">${c.region || ''}</span>
                        ${c.osNum ? `<span class="mini-badge bg-reg" style="background:#000;">OS: ${c.osNum}</span>` : ''}
                        ${late ? `<span class="mini-badge" style="background:red;">ATRASADO</span>` : ''}
                    </div>

                    <div class="dates-row">
                        <div class="date-group">
                            <label>Solicitado:</label>
                            <input type="date" class="date-input-card" value="${c.dateReq}" onchange="window.updateCard('${c.id}', 'dateReq', this.value)">
                        </div>
                        <div class="date-group">
                            <label>Agendado:</label>
                            <input type="date" class="date-input-card" value="${c.dateSched}" onchange="window.updateCard('${c.id}', 'dateSched', this.value)">
                        </div>
                    </div>

                    <div class="tech-section">
                        <select class="tech-select-card" onchange="window.updateCard('${c.id}', 'tech', this.value)">
                            ${getTechSelectHTML(c.tech)}
                        </select>
                        <button class="btn-wa-tech" onclick="window.sendTechMsg('${c.id}')" title="Enviar WhatsApp">üì±</button>
                    </div>

                    <textarea class="desc-area-card" placeholder="Descri√ß√£o do problema..." onchange="window.updateCard('${c.id}', 'desc', this.value)">${c.desc}</textarea>

                    <div class="comments-section">
                        <div class="comment-input-row">
                            <input type="text" class="comment-input-text" placeholder="Add coment√°rio..." id="comm-in-${c.id}">
                            <button class="comment-btn-save" onclick="window.addAgendaComment('${c.id}')">üíæ</button>
                        </div>
                        <ul class="comment-list">
                            ${commentsList}
                        </ul>
                    </div>

                    <div class="card-footer">
                        <span class="last-mod">Mod: ${c.lastUpdated || '-'}</span>
                    </div>
                `;
                targetContainer.appendChild(card);
            });

            document.getElementById('count-nao-iniciado').innerText = count1;
            document.getElementById('count-em-andamento').innerText = count2;
            document.getElementById('count-concluido').innerText = count3;
        }

        onSnapshot(boardRef, (docSnap) => {
            if (docSnap.exists()) {
                currentCardsData = docSnap.data().cards || [];
                document.getElementById('status-indicator').innerText = "Online üü¢";
                window.filterCards();
            } else {
                setDoc(boardRef, { cards: [] });
            }
        });
    </script>
</body>
</html>