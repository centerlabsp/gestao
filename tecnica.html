<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o T√©cnica - CenterlabSP</title>
    <link rel="icon" type="image/png" href="icone.png">

    <script src="https://cdn.jsdelivr.net/npm/drag-drop-touch-polyfill@1.0.0/DragDropTouch.min.js"></script>

    <style>
        /* --- ESTILO KANBAN CLEAN --- */
        :root { --bg-color: #ffffff; --column-bg: #f4f5f7; --card-bg: #ffffff; --text-color: #172b4d; --header-bg: #005f87; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; overflow-x: auto; height: 100vh; display: flex; flex-direction: column; }
        
        /* HEADER FLEXBOX - CENTRALIZA√á√ÉO ABSOLUTA */
        .tech-header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            background-color: var(--header-bg); 
            padding: 10px 20px; 
            color: white; 
            flex-shrink: 0; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            position: relative; 
            height: 50px;
        }
        
        .header-left { display: flex; align-items: center; z-index: 10; }
        .header-right { display: flex; align-items: center; gap: 8px; z-index: 10; }

        /* Container Centralizado */
        .header-center {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            gap: 15px;
            white-space: nowrap;
        }

        .tech-logo { height: 40px; background: white; padding: 5px; border-radius: 5px; }
        h1 { margin: 0; font-size: 1.4em; text-transform: uppercase; letter-spacing: 1px; font-weight: 900; }

        /* BOT√ïES DE NAVEGA√á√ÉO */
        .tech-nav-btn { 
            background-color: #ffffff; 
            color: #005f87; 
            padding: 5px 10px; 
            text-decoration: none; 
            border-radius: 4px; 
            font-weight: 700; 
            font-size: 0.8em; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.2); 
            transition: 0.2s;
            white-space: nowrap; 
            cursor: pointer;
            border: none;
            display: flex; align-items: center; gap: 4px;
        }
        .tech-nav-btn:hover { background-color: #e9ecef; }

        .btn-archive-mini {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.4);
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            transition: 0.2s;
            display: flex; align-items: center; gap: 5px;
        }
        .btn-archive-mini:hover { background: rgba(255,255,255,0.3); }

        .kanban-board { display: flex; gap: 10px; align-items: flex-start; padding: 15px; height: 100%; overflow-x: auto; }
        
        .kanban-column { 
            background-color: var(--column-bg); 
            width: 250px; 
            min-width: 250px; 
            border-radius: 8px; 
            padding: 8px; 
            display: flex; flex-direction: column; 
            max-height: calc(100vh - 100px); 
            border: 1px solid #e0e0e0;
        }

        .column-header { font-weight: 800; color: #005f87; padding: 0 2px 10px 2px; text-transform: uppercase; font-size: 0.8em; border-bottom: 2px solid #ccc; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .card-count { background: #d1d5db; color: #333; padding: 2px 8px; border-radius: 12px; font-size: 0.85em; font-weight: bold;}
        .card-list { flex: 1; overflow-y: auto; min-height: 100px; padding-right: 5px; }
        .card-list::-webkit-scrollbar { width: 6px; }
        .card-list::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 4px; }

        .tech-card { 
            background-color: var(--card-bg); border-radius: 6px; padding: 10px; margin-bottom: 10px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: grab; 
            border-left: 5px solid #ccc; 
            transition: transform 0.1s, box-shadow 0.1s; font-size: 11px; 
            border-top: 1px solid #eee; border-right: 1px solid #eee; border-bottom: 1px solid #eee; 
            touch-action: pan-y; 
        }
        .tech-card:active { cursor: grabbing; }
        .tech-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }

        .late-card { border: 4px solid #dc3545 !important; }

        .card-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; gap: 5px; }
        .t-client { font-weight: 800; font-size: 1.1em; color: #333; display: block; flex: 1; line-height: 1.2; }
        
        .date-badge { font-size: 0.85em; font-weight: 800; padding: 2px 6px; border-radius: 4px; color: #fff; white-space: nowrap; flex-shrink: 0; height: fit-content; }
        .date-yellow { background-color: #ffc107; color: #000; }
        .date-red { background-color: #dc3545; }
        .date-green { background-color: #198754; }
        .date-gray { background-color: #e2e6ea; color: #555; border: 1px solid #ccc; }

        .t-city { font-size: 0.85em; color: #666; font-style: italic; display: block; margin-bottom: 5px;}
        .t-machine { font-size: 0.95em; color: #005f87; font-weight: 700; display: block; margin-bottom: 2px; }
        .t-sn-badge { background-color: #e9ecef; color: #333; border: 1px solid #ccc; border-radius: 3px; padding: 2px 6px; font-size: 0.85em; font-weight: 600; display: inline-block; margin-top: 2px;}
        
        .badges-container { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 4px; }
        .badge { color: white; font-size: 0.7em; font-weight: bold; padding: 1px 5px; border-radius: 3px; text-transform: uppercase; display: inline-block; }
        .badge-contract { background-color: #28a745; }
        .badge-consultant { background-color: #6c757d; }
        .badge-urgent { background-color: #dc3545; animation: pulse 2s infinite; }

        /* NOVA ETIQUETA DO T√âCNICO */
        .tech-resp-badge {
            background-color: #e3f2fd;
            color: #0d47a1;
            border: 1px solid #bbdefb;
            border-radius: 4px;
            padding: 2px 5px;
            font-size: 0.8em;
            font-weight: 700;
            margin-top: 4px;
            display: block; /* Pula linha */
            width: fit-content;
        }

        .tech-status-label { 
            display: block; 
            margin-top: 5px; 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-size: 0.75em; 
            font-weight: 800; 
            text-transform: uppercase; 
            border: 1px solid transparent; 
            width: fit-content;
        }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        .col-demandas .tech-card { border-left-color: #dc3545; }
        .col-reparo .tech-card { border-left-color: #fd7e14; }
        .col-val-tec .tech-card { border-left-color: #ffc107; }
        .col-val-cien .tech-card { border-left-color: #0dcaf0; }
        .col-vistoria .tech-card { border-left-color: #0d6efd; }
        .col-embalagem .tech-card { border-left-color: #6f42c1; }
        .col-pronto .tech-card { border-left-color: #198754; }

        /* --- MODAL --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: flex-start; overflow-y: auto; padding-top: 30px; }
        .modal-box { background: white; width: 90%; max-width: 600px; padding: 20px; border-radius: 8px; box-shadow: 0 5px 25px rgba(0,0,0,0.3); margin-bottom: 50px; position: relative; font-size: 12px; }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 1.5em; cursor: pointer; color: #666; font-weight: bold;}
        .modal-title { font-size: 1.3em; font-weight: 900; color: #005f87; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 5px; padding-right: 20px;}
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; background: #f0f4f8; padding: 10px; border-radius: 6px; }
        .info-item label { display: block; font-size: 0.8em; color: #555; font-weight: bold; text-transform: uppercase; margin-bottom: 1px;}
        .info-item span { font-size: 0.95em; font-weight: 600; color: #333; }
        
        .tech-form-group { margin-bottom: 10px; } 
        .tech-form-group label { display: block; font-size: 0.85em; font-weight: bold; margin-bottom: 3px; color: #333;}
        .tech-select, .tech-input { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1em;}

        .items-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; border: 1px solid #eee; padding: 10px; border-radius: 6px; background: #fafafa;}
        .check-item { display: flex; align-items: center; justify-content: space-between; font-size: 0.9em; font-weight: 600; color: #444;}
        .check-item select { width: 90px; padding: 2px; font-size: 0.9em; border-radius: 4px; border: 1px solid #ccc;}

        .comment-list { list-style: none; padding: 0; max-height: 150px; overflow-y: auto; border: 1px solid #eee; margin-top: 8px; background: #fff; border-radius: 4px;}
        .comment-item { padding: 6px; border-bottom: 1px solid #eee; font-size: 0.9em; background: #fff; display: flex; flex-direction: column; gap: 3px;}
        .comment-item:nth-child(odd) { background: #f9f9f9; }
        .comment-header-row { display: flex; justify-content: space-between; align-items: center; }
        .comment-meta { font-size: 0.85em; font-weight: bold; color: #005f87; }
        
        .save-btn { background: #28a745; color: white; border: none; padding: 10px 20px; width: 100%; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1.1em; transition: 0.2s; }
        .save-btn:hover { background: #218838; }

        .btn-archive-card { background: #6c757d; color: white; border: none; padding: 10px; width: 100%; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1em; display: none; }
        .btn-archive-card:hover { background: #5a6268; }

        /* Estat√≠sticas */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; } 
        .stat-box { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 6px; text-align: center; }
        .stat-number { font-size: 2em; font-weight: 900; color: #005f87; display: block; }
        .stat-label { font-size: 0.9em; color: #666; font-weight: bold; text-transform: uppercase; }
        
        /* FLUXOGRAMA */
        .flow-container { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; row-gap: 25px; }
        .flow-step { 
            background: #eef6fc; color: #005f87; border: 1px solid #b6d4fe; 
            padding: 10px 15px; border-radius: 25px; font-size: 0.9em; font-weight: bold;
            display: flex; align-items: center; position: relative;
        }
        .flow-step span { font-size: 1.3em; font-weight: 900; margin-left: 8px; color: #333; }
        .flow-step:not(:last-child)::after {
            content: "‚Üí";
            position: absolute;
            right: -28px;
            color: #ccc;
            font-size: 2em;
            top: 50%;
            transform: translateY(-56%);
        }
        .flow-step:not(:last-child) { margin-right: 30px; } 
        .flow-step.final-step { background-color: #d1e7dd; border-color: #badbcc; color: #0f5132; }
        .flow-step.step-delayed { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .flow-step.step-delayed span { color: #721c24; }

        /* Arquivo */
        .archive-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; }
        .archive-item { background: #fff; border: 1px solid #eee; padding: 10px; margin-bottom: 8px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .archive-actions button { margin-left: 5px; padding: 4px 8px; border-radius: 4px; cursor: pointer; border: none; font-weight: bold; font-size: 0.8em; }
        .btn-restore { background: #ffc107; color: #000; }
        .btn-delete { background: #dc3545; color: #fff; }

        @media (max-width: 900px) {
            .tech-header { height: auto; flex-direction: column; gap: 10px; padding-bottom: 15px;}
            .header-center { position: static; transform: none; margin: 5px 0; }
            .header-right { width: 100%; justify-content: center; }
            .tech-nav-btn { flex: 1; justify-content: center; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <div class="tech-header">
        <div class="header-left">
            <button onclick="window.openArchive()" class="btn-archive-mini" title="Ver Arquivos">üìÇ</button>
        </div>
        
        <div class="header-center">
            <img src="icone.png" alt="Logo" class="tech-logo">
            <h1>GEST√ÉO T√âCNICA - LIBERA√á√ÉO DE EQUIPAMENTOS</h1>
        </div>

        <div class="header-right">
            <button onclick="window.openStats()" class="tech-nav-btn">üìä Estat√≠sticas</button>
            <a href="painel.html" class="tech-nav-btn">‚öôÔ∏è Painel T√©cnico</a>
        </div>
    </div>

    <div class="kanban-board">
        <div class="kanban-column col-demandas" ondrop="drop(event)" ondragover="allowDrop(event)" id="col-DEMANDAS"><div class="column-header">Demandas <span class="card-count" id="count-DEMANDAS">0</span></div><div class="card-list"></div></div>
        <div class="kanban-column col-reparo" ondrop="drop(event)" ondragover="allowDrop(event)" id="col-REPARO"><div class="column-header">Em Reparo <span class="card-count" id="count-REPARO">0</span></div><div class="card-list"></div></div>
        <div class="kanban-column col-val-tec" ondrop="drop(event)" ondragover="allowDrop(event)" id="col-VAL_TEC"><div class="column-header">Valida√ß√£o T√©cnica <span class="card-count" id="count-VAL_TEC">0</span></div><div class="card-list"></div></div>
        <div class="kanban-column col-val-cien" ondrop="drop(event)" ondragover="allowDrop(event)" id="col-VAL_CIEN"><div class="column-header">Valida√ß√£o Cient√≠fica <span class="card-count" id="count-VAL_CIEN">0</span></div><div class="card-list"></div></div>
        <div class="kanban-column col-vistoria" ondrop="drop(event)" ondragover="allowDrop(event)" id="col-VISTORIA"><div class="column-header">Vistoria Final <span class="card-count" id="count-VISTORIA">0</span></div><div class="card-list"></div></div>
        <div class="kanban-column col-embalagem" ondrop="drop(event)" ondragover="allowDrop(event)" id="col-EMBALAGEM"><div class="column-header">Embalagem <span class="card-count" id="count-EMBALAGEM">0</span></div><div class="card-list"></div></div>
        <div class="kanban-column col-pronto" ondrop="drop(event)" ondragover="allowDrop(event)" id="col-PRONTO">
            <div class="column-header">Liberado <span class="card-count" id="count-PRONTO">0</span></div>
            <div class="card-list"></div>
        </div>
    </div>

    <div class="modal-overlay" id="techModal">
        <div class="modal-box">
            <span class="modal-close" onclick="window.closeModal()">√ó</span>
            <div class="modal-title" id="m-title"></div>
            
            <div class="info-grid">
                <div class="info-item"><label>Local Manuten√ß√£o:</label><span id="m-loc"></span></div>
                <div class="info-item"><label>Contrato Assinado:</label><span id="m-contrato"></span></div>
                <div class="info-item"><label>In√≠cio Processo:</label><span id="m-inicio"></span></div>
                <div class="info-item"><label>Prev. Instala√ß√£o:</label><span id="m-prev"></span></div>
                <div class="info-item"><label>Go Live:</label><span id="m-golive"></span></div>
            </div>

            <div class="tech-form-group" id="t-status-group">
                <label style="color:#005f87; font-weight:900;">üìç ALTERAR FASE / STATUS (Mover Card):</label>
                <select class="tech-select" id="t-status">
                    <option value="DEMANDAS">DEMANDAS (AGUARDANDO)</option>
                    <option value="REPARO">EM REPARO</option>
                    <option value="VAL_TEC">VALIDA√á√ÉO T√âCNICA</option>
                    <option value="VAL_CIEN">VALIDA√á√ÉO CIENT√çFICA</option>
                    <option value="VISTORIA">VISTORIA FINAL</option>
                    <option value="EMBALAGEM">EMBALAGEM</option>
                    <option value="PRONTO">LIBERADO</option>
                </select>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div class="tech-form-group">
                    <label>In√≠cio Manuten√ß√£o:</label>
                    <input type="date" class="tech-input" id="t-start-date">
                </div>
                <div class="tech-form-group">
                    <label>Prev. Libera√ß√£o:</label>
                    <input type="date" class="tech-input" id="t-release-date">
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:5px;">
                <div class="tech-form-group">
                    <label>T√©cnico Respons√°vel:</label>
                    <select class="tech-select" id="t-responsible"></select>
                </div>
                <div class="tech-form-group">
                    <label>Assessor Respons√°vel:</label>
                    <select class="tech-select" id="t-advisor"></select>
                </div>
            </div>

            <label style="font-weight:bold; display:block; margin-bottom:5px; color:#333;">Itens Necess√°rios:</label>
            <div class="items-grid">
                <div class="check-item"><span>No-break</span> <select id="chk-nobreak"><option value="Pendente">Pendente</option><option value="Conferido">Conferido</option><option value="N/A">N/A</option></select></div>
                <div class="check-item"><span>Esta√ß√£o de √Ågua</span> <select id="chk-agua"><option value="Pendente">Pendente</option><option value="Conferido">Conferido</option><option value="N/A">N/A</option></select></div>
                <div class="check-item"><span>Computador Completo</span> <select id="chk-pc"><option value="Pendente">Pendente</option><option value="Conferido">Conferido</option><option value="N/A">N/A</option></select></div>
                <div class="check-item"><span>Acess√≥rios Equip.</span> <select id="chk-acess"><option value="Pendente">Pendente</option><option value="Conferido">Conferido</option><option value="N/A">N/A</option></select></div>
                <div class="check-item"><span>Check-list Equip.</span> <select id="chk-checklist"><option value="Pendente">Pendente</option><option value="Conferido">Conferido</option><option value="N/A">N/A</option></select></div>
            </div>

            <label style="font-weight:bold; display:block; margin-bottom:5px; color:#333;">Coment√°rios (Gest√£o e T√©cnica):</label>
            <div style="display:flex; gap:8px;">
                <input type="text" class="tech-input" id="t-comment-text" placeholder="Adicionar observa√ß√£o...">
                <button onclick="window.addTechComment()" style="width:40px; cursor:pointer; background:#28a745; color:white; border:none; border-radius:4px; font-size:1.1em;">üíæ</button>
            </div>
            <ul class="comment-list" id="t-comments-list"></ul>

            <button class="save-btn" onclick="window.saveTechData()">SALVAR E FECHAR</button>
            <button class="btn-archive-card" id="btn-archive-individual" onclick="window.archiveCurrentCard()">üóÑÔ∏è ARQUIVAR ESTE ITEM</button>
        </div>
    </div>

    <div class="modal-overlay" id="statsModal">
        <div class="modal-box" style="max-width:800px;">
            <span class="modal-close" onclick="window.closeStats()">√ó</span>
            <div class="modal-title">Estat√≠sticas do Processo</div>
            
            <div class="stats-grid">
                <div class="stat-box">
                    <span class="stat-number" id="st-total">0</span>
                    <span class="stat-label">Total Geral</span>
                </div>
                <div class="stat-box">
                    <span class="stat-number" style="color:#28a745;" id="st-dia">0</span>
                    <span class="stat-label">Em Dia</span>
                </div>
                <div class="stat-box">
                    <span class="stat-number" style="color:#dc3545;" id="st-atraso">0</span>
                    <span class="stat-label">Atrasados</span>
                </div>
                 <div class="stat-box">
                    <span class="stat-number" style="color:#6f42c1;" id="st-liberados">0</span>
                    <span class="stat-label">Liberados</span>
                </div>
                 <div class="stat-box">
                    <span class="stat-number" style="color:#6c757d;" id="st-arquivados">0</span>
                    <span class="stat-label">Arquivados</span>
                </div>
            </div>
            
            <h4 style="margin-bottom:15px; color:#333; text-align:center;">Fluxo do Processo:</h4>
            <div id="stats-phases" class="flow-container"></div>
        </div>
    </div>

    <div class="modal-overlay" id="archiveModal">
        <div class="modal-box">
            <span class="modal-close" onclick="window.closeArchive()">√ó</span>
            <div class="modal-title">Arquivo de Liberados</div>
            <p style="color:#666; margin-bottom:10px;">Lista de equipamentos que foram conclu√≠dos e arquivados.</p>
            <ul class="archive-list" id="archive-list"></ul>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA3Xg_0LLGDVeRv5jVGnSFESc8I4Z1fsA8",
            authDomain: "projeto-atellica.firebaseapp.com",
            projectId: "projeto-atellica",
            storageBucket: "projeto-atellica.firebasestorage.app",
            messagingSenderId: "422526536640",
            appId: "1:422526536640:web:0afcb40f3e79ccf93e9625"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const boardRef = doc(db, "scrum_board", "siemens_db_oficial");

        let currentCardsData = [];
        let currentModalId = null;
        let editingCommentId = null;

        const techStatusMap = {
            'DEMANDAS': { label: 'AGUARDANDO T√âCNICO', color: '#6c757d' }, 
            'REPARO': { label: 'EM REPARO', color: '#fd7e14' },
            'VAL_TEC': { label: 'VAL. T√âCNICA', color: '#ffc107' },
            'VAL_CIEN': { label: 'VAL. CIENT√çFICA', color: '#0dcaf0' },
            'VISTORIA': { label: 'VISTORIA FINAL', color: '#0d6efd' },
            'EMBALAGEM': { label: 'EMBALAGEM', color: '#6f42c1' },
            'PRONTO': { label: 'LIBERADO', color: '#198754' }
        };

        const statusOrder = ['DEMANDAS', 'REPARO', 'VAL_TEC', 'VAL_CIEN', 'VISTORIA', 'EMBALAGEM', 'PRONTO'];

        const techsByRegion = {
            "T√âCNICO SP": [ "Daniel Ourique", "Daniel Serrano", "Eduardo Rafael", "Fabio Mazine", "Guilherme Yoshida", "Matheus Pereira", "Oseias Barbosa", "Rafael Rodrigues", "Robson Miranda", "Rubens Emerson", "Vanleno C√¢mara", "Wesley Monteiro" ].sort(),
            "T√âCNICO RP": [ "Alexandre Chiang", "Fred Shigeyo", "M√°rio Luiz", "Rafael Aihara", "Rainan Hanzi" ].sort(),
            "T√âCNICO RS": [ "Adilson Domingues", "Nilton Cesar Alves" ].sort(),
            "T√âCNICO SCS": [ "Marcelo" ]
        };

        const advisorsByRegion = {
            "ASSESSOR SP": ["Mateus Ribeiro", "M√°rcia Pereira", "Lucas Ferreira", "Rayane Melo"],
            "ASSESSOR RS": ["Renata Silveira"],
            "ASSESSOR RP": ["Ricardo William"]
        };

        const techSelect = document.getElementById('t-responsible');
        techSelect.innerHTML = '<option value="">Selecione...</option>';
        for (const [region, names] of Object.entries(techsByRegion)) {
            const group = document.createElement('optgroup'); group.label = region;
            names.forEach(name => { const opt = document.createElement('option'); opt.value = name; opt.innerText = name; group.appendChild(opt); });
            techSelect.appendChild(group);
        }

        const advSelect = document.getElementById('t-advisor');
        advSelect.innerHTML = '<option value="">Selecione...</option>';
        for (const [region, names] of Object.entries(advisorsByRegion)) {
            const group = document.createElement('optgroup'); group.label = region;
            names.forEach(name => { const opt = document.createElement('option'); opt.value = name; opt.innerText = name; group.appendChild(opt); });
            advSelect.appendChild(group);
        }

        window.allowDrop = function(ev) { ev.preventDefault(); }
        window.drag = function(ev) { ev.dataTransfer.setData("text", ev.target.id); }
        window.drop = function(ev) {
            ev.preventDefault();
            const cardId = ev.dataTransfer.getData("text");
            let target = ev.target;
            while (target && !target.classList.contains('kanban-column')) { target = target.parentElement; }
            if (target) {
                const newStatus = target.id.replace('col-', '');
                window.updateTechStatus(cardId, newStatus);
            }
        }

        window.updateTechStatus = async function(cardId, newStatus) {
            const idx = currentCardsData.findIndex(c => c.id === cardId);
            if(idx > -1) {
                const card = currentCardsData[idx];
                const oldStatus = card.technicalStatus;
                card.technicalStatus = newStatus;
                
                await updateDoc(boardRef, { cards: currentCardsData });

                if(newStatus === 'PRONTO' && oldStatus !== 'PRONTO') {
                    if(confirm("Equipamento LIBERADO! Deseja enviar mensagem para o Administrativo agora?")) {
                        sendWhatsapp(card);
                    }
                }
            }
        }

        function sendWhatsapp(card) {
            const phone = "5511988133963";
            const msg = `Ol√°, o equipamento do cliente *${card.client.trim()}* foi LIBERADO pelo setor t√©cnico.\n\n*Modelo:* ${card.machine}\n*S/N:* ${card.serialsText || 'N/A'}`;
            const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        }

        onSnapshot(boardRef, (docSnap) => {
            if (docSnap.exists()) {
                currentCardsData = docSnap.data().cards || [];
                renderKanban(currentCardsData);
                if(currentModalId) {
                    const card = currentCardsData.find(c => c.id === currentModalId);
                    if(card) renderTechComments(card.comments);
                }
            }
        });

        const escapeAttr = (str) => String(str).replace(/'/g, "\\'").replace(/"/g, "&quot;");

        window.openCardModal = function(id) {
            const card = currentCardsData.find(c => c.id === id); if(!card) return; currentModalId = id;
            document.getElementById('m-title').innerText = `${card.client} | ${card.machine} | ${card.serialsText || 'S/N N/A'}`;
            document.getElementById('m-loc').innerText = card.locManut || '---';
            document.getElementById('m-contrato').innerText = formatDate(card.dateContract);
            document.getElementById('m-inicio').innerText = formatDate(card.dateStart);
            document.getElementById('m-prev').innerText = formatDate(card.datePrevInst);
            document.getElementById('m-golive').innerText = formatDate(card.dateGoLive);
            
            document.getElementById('t-start-date').value = card.techMaintenanceStart || '';
            document.getElementById('t-release-date').value = card.techReleaseForecast || '';
            document.getElementById('t-responsible').value = card.techResponsible || '';
            document.getElementById('t-advisor').value = card.techAdvisor || ''; 
            
            const status = card.technicalStatus || 'DEMANDAS';
            document.getElementById('t-status').value = status;

            const archiveBtn = document.getElementById('btn-archive-individual');
            if (status === 'PRONTO') {
                archiveBtn.style.display = 'block';
            } else {
                archiveBtn.style.display = 'none';
            }

            const checks = card.techChecklist || {};
            document.getElementById('chk-nobreak').value = checks.nobreak || 'Pendente';
            document.getElementById('chk-agua').value = checks.agua || 'Pendente';
            document.getElementById('chk-pc').value = checks.pc || 'Pendente';
            document.getElementById('chk-acess').value = checks.acess || 'Pendente';
            document.getElementById('chk-checklist').value = checks.checklist || 'Pendente'; 

            renderTechComments(card.comments);
            document.getElementById('techModal').style.display = 'flex';
        }

        function formatDate(dateStr) { if(!dateStr) return '---'; const [y, m, d] = dateStr.split('-'); return `${d}/${m}/${y}`; }

        function renderTechComments(comments) {
            const list = document.getElementById('t-comments-list'); list.innerHTML = ''; if(!comments) return;
            comments.forEach((c) => {
                let text = '', meta = '', time = '', id = '';
                if(typeof c === 'string') { text = c; id = c; } 
                else { text = c.text; id = c.id; time = c.time; meta = `[${c.stage}] (${c.module})`; }
                const safeId = escapeAttr(id); 
                const li = document.createElement('li'); li.className = 'comment-item';
                li.innerHTML = `
                    <div class="comment-header-row">
                        <span class="comment-meta">${meta} <span style="font-size:0.8em;color:#888;">${time}</span></span>
                        <div>
                            <button onclick="window.editTechComment('${safeId}')" style="border:none;background:none;cursor:pointer;color:#005f87;margin-right:5px;">‚úé</button>
                            <button onclick="window.deleteTechComment('${safeId}')" style="border:none;background:none;cursor:pointer;color:#dc3545;">‚ùå</button>
                        </div>
                    </div>
                    <div style="margin-top:4px;">${text}</div>
                `;
                list.appendChild(li);
            });
        }

        window.addTechComment = async function() {
            const text = document.getElementById('t-comment-text').value; if(!text) return;
            const idx = currentCardsData.findIndex(c => c.id === currentModalId);
            if(idx > -1) {
                if(editingCommentId) {
                    const cIdx = currentCardsData[idx].comments.findIndex(c => (typeof c === 'object' ? c.id : c) === editingCommentId);
                    if(cIdx > -1) {
                        currentCardsData[idx].comments[cIdx].text = text;
                        currentCardsData[idx].comments[cIdx].time = new Date().toLocaleString('pt-BR') + ' (Editado)';
                    }
                    editingCommentId = null;
                } else {
                    if(!currentCardsData[idx].comments) currentCardsData[idx].comments = [];
                    currentCardsData[idx].comments.push({ id: 'tc-' + Date.now(), text: text, stage: 'ASSIST√äNCIA T√âCNICA', module: 'T√âCNICO', time: new Date().toLocaleString('pt-BR') });
                }
                document.getElementById('t-comment-text').value = '';
                renderTechComments(currentCardsData[idx].comments);
                await updateDoc(boardRef, { cards: currentCardsData });
            }
        }

        window.editTechComment = function(commentId) {
            const card = currentCardsData.find(c => c.id === currentModalId);
            const comment = card.comments.find(c => (typeof c === 'object' ? c.id : c) === commentId);
            if(comment) { 
                document.getElementById('t-comment-text').value = typeof comment === 'string' ? comment : comment.text; 
                editingCommentId = commentId; 
                document.getElementById('t-comment-text').focus(); 
            }
        }

        window.deleteTechComment = async function(commentId) {
            const idx = currentCardsData.findIndex(c => c.id === currentModalId);
            if(idx > -1 && confirm('Excluir coment√°rio?')) {
                currentCardsData[idx].comments = currentCardsData[idx].comments.filter(c => {
                    if(typeof c === 'string') return c !== commentId;
                    return c.id !== commentId;
                });
                renderTechComments(currentCardsData[idx].comments);
                await updateDoc(boardRef, { cards: currentCardsData });
            }
        }

        window.saveTechData = async function() {
            if(!currentModalId) return;
            const idx = currentCardsData.findIndex(c => c.id === currentModalId);
            if(idx > -1) {
                const card = currentCardsData[idx];
                const oldStatus = card.technicalStatus;
                const newStatus = document.getElementById('t-status').value;

                card.technicalStatus = newStatus;
                card.techMaintenanceStart = document.getElementById('t-start-date').value;
                card.techReleaseForecast = document.getElementById('t-release-date').value;
                card.techResponsible = document.getElementById('t-responsible').value;
                card.techAdvisor = document.getElementById('t-advisor').value; 
                
                card.techChecklist = {
                    nobreak: document.getElementById('chk-nobreak').value,
                    agua: document.getElementById('chk-agua').value,
                    pc: document.getElementById('chk-pc').value,
                    acess: document.getElementById('chk-acess').value,
                    checklist: document.getElementById('chk-checklist').value
                };
                
                await updateDoc(boardRef, { cards: currentCardsData });
                window.closeModal();

                if(newStatus === 'PRONTO' && oldStatus !== 'PRONTO') {
                    if(confirm("Equipamento LIBERADO! Deseja enviar mensagem para o Administrativo agora?")) {
                        sendWhatsapp(card);
                    }
                }
            }
        }

        window.closeModal = function() { document.getElementById('techModal').style.display = 'none'; currentModalId = null; editingCommentId = null; }

        function renderKanban(cards) {
            cards.sort((a, b) => {
                if (a.isUrgent && !b.isUrgent) return -1;
                if (!a.isUrgent && b.isUrgent) return 1;
                const d1 = new Date(a.dateContract || '9999-12-31'); 
                const d2 = new Date(b.dateContract || '9999-12-31'); 
                return d1 - d2;
            });

            const cols = ['DEMANDAS', 'REPARO', 'VAL_TEC', 'VAL_CIEN', 'VISTORIA', 'EMBALAGEM', 'PRONTO'];
            const counts = {}; cols.forEach(c => { document.querySelector(`#col-${c} .card-list`).innerHTML = ''; counts[c] = 0; });

            const today = new Date();
            today.setHours(0,0,0,0);

            cards.forEach(card => {
                if(card.isDeleted) return; 
                const status = card.technicalStatus || 'DEMANDAS';
                
                if (status === 'ARCHIVED') return;

                if (cols.includes(status)) {
                    const el = document.createElement('div');
                    el.className = 'tech-card';
                    el.id = card.id;
                    el.draggable = true;
                    el.ondragstart = window.drag;
                    el.onclick = () => openCardModal(card.id);

                    let dateClass = 'date-gray';
                    let dateText = 'S/D';
                    let isLate = false;

                    if (card.techReleaseForecast) {
                        const parts = card.techReleaseForecast.split('-');
                        dateText = `${parts[2]}/${parts[1]}/${parts[0]}`;
                        const releaseDate = new Date(card.techReleaseForecast + 'T00:00:00');

                        if (status === 'PRONTO') {
                            dateClass = 'date-green';
                        } else {
                            if (releaseDate < today) {
                                isLate = true;
                                dateClass = 'date-red';
                            } else {
                                dateClass = 'date-yellow';
                            }
                        }
                    } else {
                        if (status === 'PRONTO') { dateClass = 'date-green'; dateText = 'LIBERADO'; }
                    }

                    if (isLate) el.classList.add('late-card');

                    const urgentBadge = card.isUrgent ? `<span class="badge badge-urgent">URGENTE</span>` : '';
                    const consultantBadge = card.consultant ? `<span class="badge badge-consultant">${card.consultant}</span>` : '';
                    const techLabel = techStatusMap[status] || techStatusMap['DEMANDAS'];
                    const techBadgeHTML = `<div class="tech-status-label" style="color:${techLabel.color}; border-color:${techLabel.color}; margin-bottom:5px;">[Assist√™ncia T√©cnica: ${techLabel.label}]</div>`;
                    
                    const techRespHTML = card.techResponsible ? `<div class="tech-resp-badge">üë§ ${card.techResponsible}</div>` : '';

                    el.innerHTML = `
                        <div class="card-header-row">
                            <span class="t-client">${card.client}</span>
                            <span class="date-badge ${dateClass}">${dateText}</span>
                        </div>
                        <div class="badges-container">
                            ${urgentBadge}
                            ${consultantBadge}
                            <span class="badge badge-contract">${card.contract || '---'}</span>
                        </div>
                        <span class="t-city">${card.city || ''}</span>
                        <span class="t-machine">${card.machine}</span>
                        <span class="t-sn-badge">${card.serialsText || 'S/N N/A'}</span>
                        ${techRespHTML}
                        ${techBadgeHTML}
                    `;
                    document.querySelector(`#col-${status} .card-list`).appendChild(el);
                    counts[status]++;
                }
            });
            cols.forEach(c => document.getElementById(`count-${c}`).innerText = counts[c]);
        }

        window.openStats = function() {
            let total = 0, emDia = 0, atrasados = 0, liberados = 0, arquivados = 0;
            const phases = { 'DEMANDAS':0, 'REPARO':0, 'VAL_TEC':0, 'VAL_CIEN':0, 'VISTORIA':0, 'EMBALAGEM':0, 'PRONTO':0 };
            
            // Objeto para rastrear se uma fase tem atraso
            const phasesHasDelay = { 'DEMANDAS':false, 'REPARO':false, 'VAL_TEC':false, 'VAL_CIEN':false, 'VISTORIA':false, 'EMBALAGEM':false, 'PRONTO':false };

            const today = new Date(); today.setHours(0,0,0,0);

            currentCardsData.forEach(c => {
                if(c.isDeleted) return;

                // Contagem de Arquivados
                if(c.technicalStatus === 'ARCHIVED') {
                    arquivados++;
                    return; 
                }

                total++;
                const status = c.technicalStatus || 'DEMANDAS';
                
                if(phases[status] !== undefined) phases[status]++;

                if(status === 'PRONTO') {
                    liberados++;
                    emDia++; 
                } else {
                    let isLate = false;
                    if(c.techReleaseForecast) {
                        const rDate = new Date(c.techReleaseForecast + 'T00:00:00');
                        if(rDate < today) isLate = true;
                    }

                    if(isLate) {
                        atrasados++;
                        phasesHasDelay[status] = true; 
                    } else {
                        emDia++; 
                    }
                }
            });

            document.getElementById('st-total').innerText = total;
            document.getElementById('st-dia').innerText = emDia;
            document.getElementById('st-atraso').innerText = atrasados;
            document.getElementById('st-liberados').innerText = liberados;
            document.getElementById('st-arquivados').innerText = arquivados;

            const phDiv = document.getElementById('stats-phases');
            phDiv.innerHTML = '';
            
            statusOrder.forEach(key => {
                const count = phases[key];
                const label = key === 'PRONTO' ? 'LIBERADO' : techStatusMap[key].label;
                const isFinal = key === 'PRONTO';
                const finalClass = isFinal ? 'final-step' : '';
                
                // Verifica se a fase tem atraso para adicionar classe vermelha
                const delayedClass = phasesHasDelay[key] ? 'step-delayed' : '';
                
                phDiv.innerHTML += `
                    <div class="flow-step ${finalClass} ${delayedClass}">
                        ${label}: <span>${count}</span>
                    </div>
                `;
            });

            document.getElementById('statsModal').style.display = 'flex';
        }
        window.closeStats = function() { document.getElementById('statsModal').style.display = 'none'; }

        window.archiveCurrentCard = async function() {
            if(!currentModalId) return;
            if(!confirm('Deseja arquivar este equipamento? Ele sair√° do quadro principal.')) return;
            const idx = currentCardsData.findIndex(c => c.id === currentModalId);
            if(idx > -1) {
                currentCardsData[idx].technicalStatus = 'ARCHIVED';
                await updateDoc(boardRef, { cards: currentCardsData });
                window.closeModal();
            }
        }

        window.openArchive = function() {
            const list = document.getElementById('archive-list');
            list.innerHTML = '';
            const archived = currentCardsData.filter(c => c.technicalStatus === 'ARCHIVED' && !c.isDeleted);
            if(archived.length === 0) {
                list.innerHTML = '<li style="padding:10px; color:#666;">Nenhum item arquivado.</li>';
            } else {
                archived.forEach(c => {
                    const li = document.createElement('li');
                    li.className = 'archive-item';
                    li.innerHTML = `
                        <div>
                            <strong>${c.client}</strong> - ${c.machine}<br>
                            <span style="font-size:0.85em; color:#666;">Contrato: ${c.contract || '---'} | S/N: ${c.serialsText || ''}</span>
                        </div>
                        <div class="archive-actions">
                            <button class="btn-restore" onclick="window.restoreCard('${c.id}')">Restaurar</button>
                            <button class="btn-delete" onclick="window.deleteCardPermanent('${c.id}')">Excluir</button>
                        </div>
                    `;
                    list.appendChild(li);
                });
            }
            document.getElementById('archiveModal').style.display = 'flex';
        }
        window.closeArchive = function() { document.getElementById('archiveModal').style.display = 'none'; }

        window.restoreCard = async function(id) {
            if(!confirm('Restaurar este item para LIBERADO?')) return;
            const idx = currentCardsData.findIndex(c => c.id === id);
            if(idx > -1) {
                currentCardsData[idx].technicalStatus = 'PRONTO';
                await updateDoc(boardRef, { cards: currentCardsData });
                window.openArchive(); 
            }
        }

        window.deleteCardPermanent = async function(id) {
            if(!confirm('ATEN√á√ÉO: Isso excluir√° o card PERMANENTEMENTE. Continuar?')) return;
            const idx = currentCardsData.findIndex(c => c.id === id);
            if(idx > -1) {
                currentCardsData[idx].isDeleted = true; 
                await updateDoc(boardRef, { cards: currentCardsData });
                window.openArchive();
            }
        }
    </script>
</body>
</html>